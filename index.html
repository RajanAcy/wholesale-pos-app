<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wholesale POS - Complete Solution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            min-height: 100vh;
        }

        .active-tab {
            background-color: #4f46e5;
            color: white;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px 3px rgba(0, 0, 0, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .tab-content.hidden {
            display: none;
        }

        .modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <!-- Main Application Container -->
    <div id="app-container" class="bg-white rounded-2xl shadow-xl w-full max-w-7xl overflow-hidden p-6 md:p-8 relative hidden">

        <!-- Header -->
        <header class="flex flex-col md:flex-row items-center justify-between pb-6 mb-6 border-b border-gray-200">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">Wholesale POS System</h1>
            <div class="mt-4 md:mt-0 flex items-center space-x-4">
                <span id="current-user-info" class="text-gray-600 text-sm"></span>
                <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-600 transition-colors">Logout</button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex justify-between md:justify-start space-x-2 md:space-x-4 mb-6 md:mb-8">
            <button id="pos-tab" class="tab-btn active-tab px-4 md:px-6 py-2 rounded-xl text-sm md:text-base font-medium transition-colors duration-200">Point of Sale</button>
            <button id="products-tab" class="tab-btn px-4 md:px-6 py-2 rounded-xl text-sm md:text-base font-medium text-gray-600 hover:bg-gray-200 transition-colors duration-200">Products</button>
            <button id="customers-tab" class="tab-btn px-4 md:px-6 py-2 rounded-xl text-sm md:text-base font-medium text-gray-600 hover:bg-gray-200 transition-colors duration-200">Customers</button>
            <button id="reports-tab" class="tab-btn px-4 md:px-6 py-2 rounded-xl text-sm md:text-base font-medium text-gray-600 hover:bg-gray-200 transition-colors duration-200">Reports</button>
            <button id="settings-tab" class="tab-btn px-4 md:px-6 py-2 rounded-xl text-sm md:text-base font-medium text-gray-600 hover:bg-gray-200 transition-colors duration-200">Settings</button>
        </nav>

        <!-- Tab Contents -->
        <div id="tab-container">

            <!-- POS Tab -->
            <div id="pos-content" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="mb-4">
                        <label for="barcode-input" class="block text-sm font-medium text-gray-700 mb-1">Scan or Enter Barcode</label>
                        <input type="text" id="barcode-input" placeholder="Scan or enter barcode..." class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    </div>
                    <div class="flex items-center space-x-4 mb-4">
                        <input type="text" id="product-search" placeholder="Search products by name..." class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <button id="clear-search-btn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-400 transition-colors">Clear</button>
                    </div>
                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-[600px] overflow-y-auto custom-scrollbar">
                        <!-- Product cards will be dynamically inserted here -->
                    </div>
                </div>
                <div class="lg:col-span-1">
                    <div class="bg-gray-100 rounded-2xl p-6 shadow-md h-full flex flex-col">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Current Sale</h2>
                        <div class="mb-4">
                            <label for="customer-select" class="block text-sm font-medium text-gray-700">Select Customer</label>
                            <select id="customer-select" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">Walk-in Customer</option>
                            </select>
                        </div>
                        <div id="cart-items" class="flex-grow max-h-[400px] overflow-y-auto custom-scrollbar mb-4">
                            <div class="text-center text-gray-500 py-8" id="empty-cart-message">Cart is empty.</div>
                        </div>
                        <div class="border-t border-gray-300 pt-4 mt-auto">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-lg font-medium text-gray-700">Subtotal:</span>
                                <span id="subtotal" class="text-lg font-bold text-gray-900">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-lg font-medium text-gray-700">Total:</span>
                                <span id="total" class="text-2xl font-extrabold text-indigo-600">$0.00</span>
                            </div>
                            <button id="checkout-btn" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-lg hover:bg-indigo-700 transition-colors shadow-lg">Checkout</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products-content" class="tab-content hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold">Product Management</h2>
                    <button id="add-product-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Add New Product</button>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white rounded-lg">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Barcode</th>
                                <th class="py-3 px-6 text-left">Name</th>
                                <th class="py-3 px-6 text-left">Category</th>
                                <th class="py-3 px-6 text-left">Price ($)</th>
                                <th class="py-3 px-6 text-left">Stock</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body" class="text-gray-600 text-sm font-light">
                            <!-- Product rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customers-content" class="tab-content hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold">Customer Management</h2>
                    <button id="add-customer-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Add New Customer</button>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white rounded-lg">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Name</th>
                                <th class="py-3 px-6 text-left">Email</th>
                                <th class="py-3 px-6 text-left">Phone</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body" class="text-gray-600 text-sm font-light">
                            <!-- Customer rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Sales Reports</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-medium text-gray-600">Total Sales</h3>
                        <p id="total-sales-value" class="text-3xl font-extrabold text-indigo-600 mt-2">$0.00</p>
                    </div>
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-medium text-gray-600">Total Orders</h3>
                        <p id="total-orders-value" class="text-3xl font-extrabold text-indigo-600 mt-2">0</p>
                    </div>
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-medium text-gray-600">Average Order Value</h3>
                        <p id="aov-value" class="text-3xl font-extrabold text-indigo-600 mt-2">$0.00</p>
                    </div>
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-lg font-medium text-gray-600">Most Sold Item</h3>
                        <p id="most-sold-item-value" class="text-xl font-bold text-gray-800 mt-2">N/A</p>
                    </div>
                </div>

                <h3 class="text-xl font-bold mb-4">Sales History</h3>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white rounded-lg">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Order ID</th>
                                <th class="py-3 px-6 text-left">Date</th>
                                <th class="py-3 px-6 text-left">Customer</th>
                                <th class="py-3 px-6 text-left">Total ($)</th>
                                <th class="py-3 px-6 text-center">Items</th>
                            </tr>
                        </thead>
                        <tbody id="sales-history-body" class="text-gray-600 text-sm font-light">
                            <!-- Sales history rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Settings</h2>
                <div class="bg-white rounded-2xl shadow p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">Data Management</h3>
                    <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4">
                        <button id="export-cloud-btn" class="w-full md:w-auto bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-lg">
                            Export Data to Cloud
                        </button>
                        <button id="import-cloud-btn" class="w-full md:w-auto bg-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-700 transition-colors shadow-lg">
                            Import Data from Cloud
                        </button>
                    </div>
                    <div class="mt-6 text-sm text-gray-600">
                        <p>Note: Cloud functionality is simulated and will download/upload files to your local machine.</p>
                        <p id="cloud-link-info" class="mt-2 hidden">Your Cloud Folder Link: <a id="cloud-link-display" href="#" target="_blank" class="text-blue-600 underline hover:text-blue-800"></a></p>
                    </div>
                </div>

                <!-- Admin-only User Management Section -->
                <div id="user-management-section" class="bg-white rounded-2xl shadow p-6 hidden">
                    <h3 class="text-xl font-bold mb-4">User Management</h3>
                    <form id="add-user-form" class="space-y-4">
                        <div>
                            <label for="new-user-email" class="block text-sm font-medium text-gray-700">New User Email</label>
                            <input type="email" id="new-user-email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="new-user-role" class="block text-sm font-medium text-gray-700">Role</label>
                            <select id="new-user-role" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                            Add User
                        </button>
                    </form>
                    <div class="mt-4">
                        <h4 class="font-bold mb-2">Current Users</h4>
                        <ul id="user-list" class="space-y-2 text-sm text-gray-700">
                            <!-- Dynamically added users -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50 opacity-0 pointer-events-none">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-lg transform -translate-y-4 transition-transform duration-300">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-900 mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-4"></p>
            <div id="modal-additional-content" class="text-gray-600"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button id="modal-secondary-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors">Cancel</button>
                <button id="modal-primary-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-900" id="auth-title">Log In</h2>
            <div id="auth-error-message" class="text-red-500 text-sm text-center mb-4 hidden"></div>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="auth-email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="cloud-link-container" class="hidden">
                    <label for="auth-cloud-link" class="block text-sm font-medium text-gray-700">Cloud Folder Link</label>
                    <input type="url" id="auth-cloud-link" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div id="role-container" class="hidden">
                    <label for="auth-role" class="block text-sm font-medium text-gray-700">Role</label>
                    <select id="auth-role" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="admin">Admin</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                    Log In
                </button>
                <button type="button" id="auth-toggle-btn" class="w-full text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
                    Don't have an account? Sign Up
                </button>
            </form>
            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-400"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-sm">Or</span>
                <div class="flex-grow border-t border-gray-400"></div>
            </div>
            <button id="guest-login-btn" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                Continue as Guest
            </button>
        </div>
    </div>

    <!-- Firebase Script and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot, query, where, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app, db, auth;
        let userId = null;
        let userProfile = null; // Stores user data (role, cloud link)
        let isAuthReady = false;

        const PRODUCTS_COLLECTION = 'products';
        const CUSTOMERS_COLLECTION = 'customers';
        const SALES_COLLECTION = 'sales';
        const USERS_COLLECTION = 'users';
        const ACCESS_LIST_COLLECTION = 'access_list';

        const store = {
            products: [],
            customers: [],
            sales: [],
            currentUser: null,
            cart: [],
            currentCustomer: null,
            reports: {
                totalSales: 0,
                totalOrders: 0,
                aov: 0,
                mostSoldItem: 'N/A'
            },
            isImporting: false
        };

        const elements = {
            appContainer: document.getElementById('app-container'),
            tabButtons: document.querySelectorAll('.tab-btn'),
            tabContents: document.querySelectorAll('.tab-content'),
            posContent: document.getElementById('pos-content'),
            productsContent: document.getElementById('products-content'),
            customersContent: document.getElementById('customers-content'),
            reportsContent: document.getElementById('reports-content'),
            settingsContent: document.getElementById('settings-content'),
            productList: document.getElementById('product-list'),
            productSearch: document.getElementById('product-search'),
            clearSearchBtn: document.getElementById('clear-search-btn'),
            barcodeInput: document.getElementById('barcode-input'),
            customerSelect: document.getElementById('customer-select'),
            cartItems: document.getElementById('cart-items'),
            emptyCartMessage: document.getElementById('empty-cart-message'),
            subtotalElement: document.getElementById('subtotal'),
            totalElement: document.getElementById('total'),
            checkoutBtn: document.getElementById('checkout-btn'),
            addProductBtn: document.getElementById('add-product-btn'),
            productTableBody: document.getElementById('product-table-body'),
            addCustomerBtn: document.getElementById('add-customer-btn'),
            customerTableBody: document.getElementById('customer-table-body'),
            totalSalesValue: document.getElementById('total-sales-value'),
            totalOrdersValue: document.getElementById('total-orders-value'),
            aovValue: document.getElementById('aov-value'),
            mostSoldItemValue: document.getElementById('most-sold-item-value'),
            salesHistoryBody: document.getElementById('sales-history-body'),
            exportCloudBtn: document.getElementById('export-cloud-btn'),
            importCloudBtn: document.getElementById('import-cloud-btn'),
            currentUserInfo: document.getElementById('current-user-info'),
            logoutBtn: document.getElementById('logout-btn'),
            modalContainer: document.getElementById('modal-container'),
            modalContent: document.getElementById('modal-content'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalAdditionalContent: document.getElementById('modal-additional-content'),
            modalPrimaryBtn: document.getElementById('modal-primary-btn'),
            modalSecondaryBtn: document.getElementById('modal-secondary-btn'),
            authModal: document.getElementById('auth-modal'),
            authTitle: document.getElementById('auth-title'),
            authForm: document.getElementById('auth-form'),
            authEmail: document.getElementById('auth-email'),
            authPassword: document.getElementById('auth-password'),
            authCloudLinkContainer: document.getElementById('cloud-link-container'),
            authCloudLink: document.getElementById('auth-cloud-link'),
            authRoleContainer: document.getElementById('role-container'),
            authRole: document.getElementById('auth-role'),
            authSubmitBtn: document.getElementById('auth-submit-btn'),
            authToggleBtn: document.getElementById('auth-toggle-btn'),
            authErrorMessage: document.getElementById('auth-error-message'),
            guestLoginBtn: document.getElementById('guest-login-btn'),
            cloudLinkInfo: document.getElementById('cloud-link-info'),
            cloudLinkDisplay: document.getElementById('cloud-link-display'),
            userManagementSection: document.getElementById('user-management-section'),
            addUserForm: document.getElementById('add-user-form'),
            newUserEmail: document.getElementById('new-user-email'),
            newUserRole: document.getElementById('new-user-role'),
            userList: document.getElementById('user-list')
        };

        let isSignup = false;

        // Utility Functions
        const formatCurrency = (value) => `$${(value).toFixed(2)}`;

        const showModal = (title, message, showPrimary, primaryAction, showSecondary, secondaryAction, additionalContent = '') => {
            elements.modalTitle.textContent = title;
            elements.modalMessage.textContent = message;
            elements.modalAdditionalContent.innerHTML = additionalContent;
            
            elements.modalPrimaryBtn.style.display = showPrimary ? 'inline-block' : 'none';
            if (showPrimary) {
                elements.modalPrimaryBtn.onclick = primaryAction;
            }

            elements.modalSecondaryBtn.style.display = showSecondary ? 'inline-block' : 'none';
            if (showSecondary) {
                elements.modalSecondaryBtn.onclick = secondaryAction;
            }

            elements.modalContainer.classList.remove('opacity-0', 'pointer-events-none');
            elements.modalContent.classList.remove('-translate-y-4');
        };

        const hideModal = () => {
            elements.modalContainer.classList.add('opacity-0', 'pointer-events-none');
            elements.modalContent.classList.add('-translate-y-4');
        };

        const renderProductCard = (product) => {
            const card = document.createElement('div');
            card.className = 'product-card bg-white rounded-xl shadow-md p-4 cursor-pointer transform transition-all duration-300 hover:shadow-lg';
            card.innerHTML = `
                <div class="h-24 bg-gray-200 rounded-lg mb-4 flex items-center justify-center text-gray-500 text-sm">No Image</div>
                <h3 class="font-bold text-gray-900">${product.name}</h3>
                <p class="text-sm text-gray-600">${product.category}</p>
                <div class="flex items-center justify-between mt-2">
                    <span class="text-lg font-bold text-indigo-600">${formatCurrency(product.price)}</span>
                    <span class="text-sm font-medium ${product.stock > 0 ? 'text-green-600' : 'text-red-600'}">${product.stock > 0 ? `${product.stock} in stock` : 'Out of Stock'}</span>
                </div>
            `;
            card.addEventListener('click', () => addToCart(product));
            return card;
        };

        const renderCartItem = (item) => {
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm mb-2';
            row.innerHTML = `
                <div class="flex-1">
                    <h4 class="font-semibold">${item.name}</h4>
                    <p class="text-sm text-gray-500">${formatCurrency(item.price)} x ${item.quantity}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-bold text-indigo-600">${formatCurrency(item.price * item.quantity)}</span>
                    <button class="remove-from-cart-btn text-red-500 hover:text-red-700 transition-colors" data-id="${item.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            `;
            row.querySelector('.remove-from-cart-btn').addEventListener('click', () => removeFromCart(item.id));
            return row;
        };

        const renderProductTable = () => {
            elements.productTableBody.innerHTML = '';
            store.products.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${product.barcode || 'N/A'}</td>
                    <td class="py-3 px-6 text-left whitespace-nowrap">${product.name}</td>
                    <td class="py-3 px-6 text-left">${product.category}</td>
                    <td class="py-3 px-6 text-left">${formatCurrency(product.price)}</td>
                    <td class="py-3 px-6 text-left">${product.stock}</td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center space-x-2">
                            <button class="edit-product-btn text-blue-600 hover:text-blue-800 transition-colors" data-id="${product.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button class="delete-product-btn text-red-500 hover:text-red-700 transition-colors" data-id="${product.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                row.querySelector('.edit-product-btn').addEventListener('click', () => editProduct(product.id));
                row.querySelector('.delete-product-btn').addEventListener('click', () => confirmDeleteProduct(product.id));
                elements.productTableBody.appendChild(row);
            });
        };

        const renderCustomerSelect = () => {
            elements.customerSelect.innerHTML = '<option value="">Walk-in Customer</option>';
            store.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                elements.customerSelect.appendChild(option);
            });
            if (store.currentCustomer) {
                elements.customerSelect.value = store.currentCustomer.id;
            } else {
                elements.customerSelect.value = '';
            }
        };

        const renderCustomerTable = () => {
            elements.customerTableBody.innerHTML = '';
            store.customers.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${customer.name}</td>
                    <td class="py-3 px-6 text-left">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-6 text-left">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-6 text-center">
                        <div class="flex item-center justify-center space-x-2">
                            <button class="edit-customer-btn text-blue-600 hover:text-blue-800 transition-colors" data-id="${customer.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button class="delete-customer-btn text-red-500 hover:text-red-700 transition-colors" data-id="${customer.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                row.querySelector('.edit-customer-btn').addEventListener('click', () => editCustomer(customer.id));
                row.querySelector('.delete-customer-btn').addEventListener('click', () => confirmDeleteCustomer(customer.id));
                elements.customerTableBody.appendChild(row);
            });
        };

        const renderSalesHistoryTable = () => {
            elements.salesHistoryBody.innerHTML = '';
            store.sales.sort((a, b) => new Date(b.date) - new Date(a.date));
            store.sales.forEach(sale => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${sale.id}</td>
                    <td class="py-3 px-6 text-left">${new Date(sale.date).toLocaleDateString()}</td>
                    <td class="py-3 px-6 text-left">${sale.customerName}</td>
                    <td class="py-3 px-6 text-left">${formatCurrency(sale.total)}</td>
                    <td class="py-3 px-6 text-center">
                        <button class="view-details-btn text-blue-600 hover:text-blue-800 transition-colors" data-id="${sale.id}">View</button>
                    </td>
                `;
                row.querySelector('.view-details-btn').addEventListener('click', () => viewSaleDetails(sale));
                elements.salesHistoryBody.appendChild(row);
            });
        };

        // UI Rendering Functions
        const renderProducts = (searchTerm = '') => {
            elements.productList.innerHTML = '';
            const filteredProducts = store.products.filter(p => 
                (p.name && p.name.toLowerCase().includes(searchTerm.toLowerCase())) || 
                (p.barcode && p.barcode.includes(searchTerm))
            );
            if (filteredProducts.length === 0) {
                elements.productList.innerHTML = '<div class="text-center text-gray-500 col-span-full py-8">No products found.</div>';
            } else {
                filteredProducts.forEach(product => elements.productList.appendChild(renderProductCard(product)));
            }
        };

        const renderCart = () => {
            elements.cartItems.innerHTML = '';
            if (store.cart.length === 0) {
                elements.emptyCartMessage.style.display = 'block';
            } else {
                elements.emptyCartMessage.style.display = 'none';
                store.cart.forEach(item => elements.cartItems.appendChild(renderCartItem(item)));
            }
            updateTotals();
        };

        const renderReports = () => {
            elements.totalSalesValue.textContent = formatCurrency(store.reports.totalSales);
            elements.totalOrdersValue.textContent = store.reports.totalOrders;
            elements.aovValue.textContent = formatCurrency(store.reports.aov);
            elements.mostSoldItemValue.textContent = store.reports.mostSoldItem;
        };

        const updateTotals = () => {
            const subtotal = store.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            elements.subtotalElement.textContent = formatCurrency(subtotal);
            elements.totalElement.textContent = formatCurrency(subtotal);
        };

        const calculateReports = () => {
            const totalSales = store.sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalOrders = store.sales.length;
            const aov = totalOrders > 0 ? totalSales / totalOrders : 0;

            const productSales = {};
            store.sales.forEach(sale => {
                sale.items.forEach(item => {
                    productSales[item.id] = (productSales[item.id] || 0) + item.quantity;
                });
            });

            const mostSoldItem = Object.entries(productSales).sort(([, a], [, b]) => b - a)[0];
            const mostSoldItemName = mostSoldItem ? store.products.find(p => p.id === mostSoldItem[0])?.name : 'N/A';

            store.reports = {
                totalSales,
                totalOrders,
                aov,
                mostSoldItem: mostSoldItemName
            };
            renderReports();
        };

        // Cart Actions
        const addToCart = (product) => {
            if (product.stock <= 0) {
                showModal('Out of Stock', 'This product is currently out of stock.', false, null, true, hideModal);
                return;
            }
            const existingItem = store.cart.find(item => item.id === product.id);
            if (existingItem) {
                if (existingItem.quantity + 1 > product.stock) {
                    showModal('Stock Limit Reached', 'Cannot add more. You have reached the stock limit for this item.', false, null, true, hideModal);
                    return;
                }
                existingItem.quantity += 1;
            } else {
                store.cart.push({ ...product, quantity: 1 });
            }
            renderCart();
        };

        const removeFromCart = (id) => {
            const index = store.cart.findIndex(item => item.id === id);
            if (index !== -1) {
                store.cart[index].quantity -= 1;
                if (store.cart[index].quantity <= 0) {
                    store.cart.splice(index, 1);
                }
            }
            renderCart();
        };

        const checkout = async () => {
            if (store.cart.length === 0) {
                showModal('Checkout Failed', 'The cart is empty. Please add items before checking out.', false, null, true, hideModal);
                return;
            }

            try {
                const updates = store.cart.map(item => {
                    const productRef = doc(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION, item.id);
                    return updateDoc(productRef, {
                        stock: item.stock - item.quantity
                    });
                });
                await Promise.all(updates);

                const newSale = {
                    date: new Date().toISOString(),
                    customerName: store.currentCustomer ? store.currentCustomer.name : 'Walk-in Customer',
                    customerId: store.currentCustomer ? store.currentCustomer.id : null,
                    total: store.cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                    items: store.cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    }))
                };

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', SALES_COLLECTION), newSale);

                store.cart = [];
                store.currentCustomer = null;
                renderCart();
                showModal('Checkout Successful', 'The sale has been completed successfully.', false, null, true, hideModal);
            } catch (error) {
                console.error('Error during checkout:', error);
                showModal('Checkout Error', 'An error occurred during checkout. Please try again.', false, null, true, hideModal);
            }
        };

        // CRUD for Products
        const addEditProductModal = (product = null) => {
            const isEditing = !!product;
            const title = isEditing ? 'Edit Product' : 'Add New Product';
            const additionalContent = `
                <form id="product-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Barcode</label>
                        <input type="text" id="product-barcode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" value="${isEditing ? product.barcode || '' : ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="product-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" value="${isEditing ? product.name : ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" id="product-category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" value="${isEditing ? product.category : ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" id="product-price" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" value="${isEditing ? product.price : ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Stock</label>
                        <input type="number" id="product-stock" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" value="${isEditing ? product.stock : ''}">
                    </div>
                </form>
            `;
            showModal(title, '', true, async () => {
                const barcode = document.getElementById('product-barcode').value.trim();
                const name = document.getElementById('product-name').value.trim();
                const category = document.getElementById('product-category').value.trim();
                const price = parseFloat(document.getElementById('product-price').value);
                const stock = parseInt(document.getElementById('product-stock').value, 10);

                if (!name || !category || isNaN(price) || isNaN(stock)) {
                    showModal('Error', 'Please fill in all required fields with valid data.', true, hideModal, false, null);
                    return;
                }

                try {
                    const productData = { name, category, price, stock, barcode: barcode || null };
                    if (isEditing) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION, product.id), productData);
                        showModal('Success', 'Product updated successfully!', false, null, true, hideModal);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION), productData);
                        showModal('Success', 'New product added successfully!', false, null, true, hideModal);
                    }
                } catch (error) {
                    console.error('Error saving product:', error);
                    showModal('Error', 'Failed to save product. Please try again.', false, null, true, hideModal);
                }
            }, true, hideModal, additionalContent);
        };

        const editProduct = (id) => {
            const product = store.products.find(p => p.id === id);
            if (product) {
                addEditProductModal(product);
            }
        };

        const confirmDeleteProduct = (id) => {
            showModal('Confirm Deletion', 'Are you sure you want to delete this product?', true, async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION, id));
                    hideModal();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showModal('Error', 'Failed to delete product. Please try again.', false, null, true, hideModal);
                }
            }, true, hideModal);
        };

        // CRUD for Customers
        const addEditCustomerModal = (customer = null) => {
            const isEditing = !!customer;
            const title = isEditing ? 'Edit Customer' : 'Add New Customer';
            const additionalContent = `
                <form id="customer-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="customer-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" value="${isEditing ? customer.name : ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email (Optional)</label>
                        <input type="email" id="customer-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" value="${isEditing ? customer.email : ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Phone (Optional)</label>
                        <input type="tel" id="customer-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" value="${isEditing ? customer.phone : ''}">
                    </div>
                </form>
            `;
            showModal(title, '', true, async () => {
                const name = document.getElementById('customer-name').value.trim();
                const email = document.getElementById('customer-email').value.trim();
                const phone = document.getElementById('customer-phone').value.trim();

                if (!name) {
                    showModal('Error', 'Customer name is required.', false, null, true, hideModal);
                    return;
                }

                try {
                    const customerData = { name, email, phone };
                    if (isEditing) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION, customer.id), customerData);
                        showModal('Success', 'Customer updated successfully!', false, null, true, hideModal);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION), customerData);
                        showModal('Success', 'New customer added successfully!', false, null, true, hideModal);
                    }
                } catch (error) {
                    console.error('Error saving customer:', error);
                    showModal('Error', 'Failed to save customer. Please try again.', false, null, true, hideModal);
                }
            }, true, hideModal, additionalContent);
        };

        const editCustomer = (id) => {
            const customer = store.customers.find(c => c.id === id);
            if (customer) {
                addEditCustomerModal(customer);
            }
        };

        const confirmDeleteCustomer = (id) => {
            showModal('Confirm Deletion', 'Are you sure you want to delete this customer?', true, async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION, id));
                    hideModal();
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    showModal('Error', 'Failed to delete customer. Please try again.', false, null, true, hideModal);
                }
            }, true, hideModal);
        };

        // Data Export/Import
        const exportData = () => {
            const exportData = {
                products: store.products,
                customers: store.customers,
                sales: store.sales,
                exportDate: new Date().toISOString(),
                exportedBy: userProfile.email
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `pos-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            showModal(
                'Data Exported',
                'Your data has been downloaded. Please save this file to your computer.',
                false,
                null,
                true,
                hideModal,
                `<div class="text-left text-sm">
                    <p class="mb-2">This is a local backup. In a real application, this would be uploaded to cloud storage.</p>
                </div>`
            );
        };

        const importData = () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'application/json';
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.products || !data.customers || !data.sales) {
                            showModal('Import Failed', 'Invalid file format. Please upload a valid POS backup file.', false, null, true, hideModal);
                            return;
                        }

                        store.isImporting = true;
                        showModal('Importing Data', 'Please wait while your data is being imported...', false, null, false, null);

                        const batch = db.runTransaction(async (transaction) => {
                            const productsQuery = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION));
                            productsQuery.docs.forEach(doc => transaction.delete(doc.ref));
                            const customersQuery = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION));
                            customersQuery.docs.forEach(doc => transaction.delete(doc.ref));
                            const salesQuery = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', SALES_COLLECTION));
                            salesQuery.docs.forEach(doc => transaction.delete(doc.ref));

                            data.products.forEach(p => {
                                const newDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION));
                                transaction.set(newDocRef, p);
                            });
                            data.customers.forEach(c => {
                                const newDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION));
                                transaction.set(newDocRef, c);
                            });
                            data.sales.forEach(s => {
                                const newDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', SALES_COLLECTION));
                                transaction.set(newDocRef, s);
                            });
                        });
                        
                        await batch;

                        showModal('Import Successful', 'Data has been successfully imported.', false, null, true, hideModal);
                        store.isImporting = false;
                    } catch (error) {
                        console.error('Error importing data:', error);
                        store.isImporting = false;
                        showModal('Import Failed', 'An error occurred during data import. Please check the file and try again.', false, null, true, hideModal);
                    }
                };
                reader.readAsText(file);
            };
            fileInput.click();
        };

        const viewSaleDetails = (sale) => {
            const itemsHtml = sale.items.map(item => `
                <li class="flex justify-between py-1">
                    <span>${item.name} x ${item.quantity}</span>
                    <span>${formatCurrency(item.price * item.quantity)}</span>
                </li>
            `).join('');

            const additionalContent = `
                <div class="text-sm">
                    <p class="mb-2"><strong>Date:</strong> ${new Date(sale.date).toLocaleString()}</p>
                    <p class="mb-2"><strong>Customer:</strong> ${sale.customerName}</p>
                    <p class="mb-2"><strong>Order ID:</strong> ${sale.id}</p>
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <p class="font-semibold text-gray-800 mb-2">Items:</p>
                        <ul class="list-disc list-inside space-y-1">
                            ${itemsHtml}
                        </ul>
                    </div>
                </div>
            `;
            showModal('Sale Details', `Total: ${formatCurrency(sale.total)}`, false, null, true, hideModal, additionalContent);
        };

        // User Management (Admin Only)
        const addUser = async (email, role) => {
            try {
                // Add the user to a public access list
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', ACCESS_LIST_COLLECTION), {
                    email,
                    role
                });
                showModal('Success', `${role} user with email ${email} added. Their ID is: ${docRef.id}`, false, null, true, hideModal);
            } catch (error) {
                console.error("Error adding user:", error);
                showModal('Error', 'Failed to add user. Please try again.', false, null, true, hideModal);
            }
        };

        const renderUserList = (users) => {
            elements.userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'bg-gray-100 p-2 rounded-lg flex justify-between items-center';
                li.innerHTML = `
                    <span>${user.email} - <span class="font-bold">${user.role}</span></span>
                    <button class="text-red-500 hover:text-red-700 transition-colors" data-id="${user.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                li.querySelector('button').addEventListener('click', async () => {
                    if (confirm(`Are you sure you want to remove ${user.email}?`)) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', ACCESS_LIST_COLLECTION, user.id));
                    }
                });
                elements.userList.appendChild(li);
            });
        };

        // Event Listeners
        elements.tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                elements.tabButtons.forEach(btn => {
                    btn.classList.remove('active-tab');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-200');
                });
                elements.tabContents.forEach(content => content.classList.add('hidden'));

                e.target.classList.add('active-tab');
                e.target.classList.remove('text-gray-600', 'hover:bg-gray-200');

                const targetId = e.target.id.replace('-tab', '-content');
                document.getElementById(targetId).classList.remove('hidden');

                if (targetId === 'products-content') renderProductTable();
                if (targetId === 'customers-content') renderCustomerTable();
                if (targetId === 'reports-content') {
                    if (store.sales.length > 0) calculateReports();
                    renderSalesHistoryTable();
                }
            });
        });

        elements.barcodeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = elements.barcodeInput.value.trim();
                const product = store.products.find(p => p.barcode === barcode);
                if (product) {
                    addToCart(product);
                    elements.barcodeInput.value = '';
                } else {
                    showModal('Product Not Found', 'No product found with that barcode.', false, null, true, hideModal);
                }
            }
        });

        elements.productSearch.addEventListener('input', (e) => {
            renderProducts(e.target.value);
        });

        elements.clearSearchBtn.addEventListener('click', () => {
            elements.productSearch.value = '';
            renderProducts();
        });

        elements.customerSelect.addEventListener('change', (e) => {
            const customerId = e.target.value;
            store.currentCustomer = store.customers.find(c => c.id === customerId) || null;
        });

        elements.checkoutBtn.addEventListener('click', checkout);
        elements.addProductBtn.addEventListener('click', () => addEditProductModal());
        elements.addCustomerBtn.addEventListener('click', () => addEditCustomerModal());
        elements.exportCloudBtn.addEventListener('click', exportData);
        elements.importCloudBtn.addEventListener('click', importData);

        elements.addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = elements.newUserEmail.value.trim();
            const role = elements.newUserRole.value;
            if (email) {
                await addUser(email, role);
                elements.newUserEmail.value = '';
            }
        });

        // Auth listeners
        let isAuthenticating = false;

        elements.authToggleBtn.addEventListener('click', () => {
            isSignup = !isSignup;
            elements.authTitle.textContent = isSignup ? 'Sign Up' : 'Log In';
            elements.authSubmitBtn.textContent = isSignup ? 'Sign Up' : 'Log In';
            elements.authToggleBtn.textContent = isSignup ? 'Already have an account? Log In' : 'Don\'t have an account? Sign Up';
            elements.authCloudLinkContainer.classList.toggle('hidden', !isSignup);
            elements.authRoleContainer.classList.toggle('hidden', !isSignup);
        });

        elements.authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isAuthenticating) return;
            isAuthenticating = true;
            elements.authSubmitBtn.disabled = true;
            elements.authErrorMessage.classList.add('hidden');
            const email = elements.authEmail.value;
            const password = elements.authPassword.value;

            try {
                let userCredential;
                if (isSignup) {
                    const cloudLink = elements.authCloudLink.value.trim();
                    const role = elements.authRole.value;
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userRef = doc(db, 'artifacts', appId, USERS_COLLECTION, userCredential.user.uid);
                    await setDoc(userRef, { email: userCredential.user.email, role, cloudLink: cloudLink || '' });
                } else {
                    userCredential = await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                elements.authErrorMessage.textContent = error.message;
                elements.authErrorMessage.classList.remove('hidden');
            } finally {
                isAuthenticating = false;
                elements.authSubmitBtn.disabled = false;
            }
        });

        elements.guestLoginBtn.addEventListener('click', async () => {
            if (isAuthenticating) return;
            isAuthenticating = true;
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous sign-in failed:", error.message);
                elements.authErrorMessage.textContent = error.message;
                elements.authErrorMessage.classList.remove('hidden');
            } finally {
                isAuthenticating = false;
            }
        });
        
        const handleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error.message);
            }
        };

        elements.logoutBtn.addEventListener('click', handleLogout);
        
        const init = async () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const userRef = doc(db, 'artifacts', appId, USERS_COLLECTION, userId);
                    const userDoc = await getDoc(userRef);
                    
                    if (user.isAnonymous) {
                         userProfile = { role: 'guest' };
                    } else if (userDoc.exists()) {
                         userProfile = userDoc.data();
                    } else {
                         // A new user might be signed in via email/password but their profile wasn't created
                         // If we are not in signup mode, treat them as a user.
                         if (!isSignup) {
                            userProfile = { email: user.email, role: 'user', cloudLink: '' };
                            await setDoc(userRef, userProfile);
                         } else {
                            // During signup, the profile is created above.
                            userProfile = { email: user.email, role: elements.authRole.value, cloudLink: elements.authCloudLink.value };
                         }
                    }

                    // Check if the user is authorized
                    let isAuthorized = false;
                    if (userProfile.role === 'admin' || user.isAnonymous) {
                         isAuthorized = true;
                    } else { // Normal users must be on the access list
                        const accessQuery = query(collection(db, 'artifacts', appId, 'public', 'data', ACCESS_LIST_COLLECTION), where('email', '==', user.email));
                        const accessSnapshot = await getDocs(accessQuery);
                        isAuthorized = !accessSnapshot.empty;
                    }

                    if (isAuthorized) {
                        elements.currentUserInfo.textContent = `Logged in as: ${userProfile.email || 'Guest'} (${userProfile.role || 'Guest'})`;
                        
                        if (userProfile.role !== 'admin') {
                            document.getElementById('settings-tab').classList.add('hidden');
                        } else {
                            document.getElementById('settings-tab').classList.remove('hidden');
                            elements.userManagementSection.classList.remove('hidden');
                            if (userProfile.cloudLink) {
                                elements.cloudLinkInfo.classList.remove('hidden');
                                elements.cloudLinkDisplay.href = userProfile.cloudLink;
                                elements.cloudLinkDisplay.textContent = userProfile.cloudLink;
                            }
                        }
                        
                        elements.authModal.classList.add('hidden');
                        elements.appContainer.classList.remove('hidden');
                        isAuthReady = true;
                        setupFirestoreListeners();
                    } else {
                        await signOut(auth);
                        showModal('Access Denied', 'Your account has not been authorized by an admin.', false, null, true, hideModal);
                    }
                } else {
                    elements.authModal.classList.remove('hidden');
                    elements.appContainer.classList.add('hidden');
                    isAuthReady = false;
                }
            });
        };

        const setupFirestoreListeners = () => {
             // Products Listener
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION), (snapshot) => {
                store.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
                renderProductTable();
                if (!store.isImporting) {
                   calculateReports();
                }
            });

            // Customers Listener
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION), (snapshot) => {
                store.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCustomerSelect();
                renderCustomerTable();
            });

            // Sales Listener
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', SALES_COLLECTION), (snapshot) => {
                store.sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSalesHistoryTable();
                if (!store.isImporting) {
                   calculateReports();
                }
            });

            // Admin User List Listener
            if (userProfile && userProfile.role === 'admin') {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', ACCESS_LIST_COLLECTION), (snapshot) => {
                    const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserList(users);
                });
            }
        };

        window.onload = init;
    </script>

</body>
</html>
