<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wholesale POS - Complete Solution</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- QuaggaJS for barcode scanning -->
<script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    min-height: 100vh;
}

.active-tab {
    background-color: #4f46e5;
    color: white;
}

.product-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px 3px rgba(0, 0, 0, 0.1);
}

.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #c5c5c5;
    border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.modal-content {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.tab-content {
    animation: slideIn 0.5s ease-in-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Print-specific styles for the receipt */
@media print {
    body * {
        visibility: hidden;
    }
    #receipt-modal-content, #receipt-modal-content * {
        visibility: visible;
    }
    #receipt-modal-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: auto;
        padding: 20px;
        background-color: white;
    }
    .no-print {
        display: none !important;
    }
}
</style>
</head>
<body>

<!-- Main application container -->
<div id="app-container" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow-sm p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Wholesale POS</h1>
            <div class="relative">
                <button id="auth-info-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-full transition-colors duration-300 shadow-lg">
                    <span id="user-display-name">Loading...</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto p-4 md:p-8">
        <!-- Tab Navigation -->
        <div class="bg-white rounded-xl shadow-lg p-2 mb-6 flex flex-wrap justify-between items-center">
            <button class="tab-btn active-tab flex-1 py-3 px-4 text-sm font-medium rounded-lg transition-colors duration-300" data-tab="pos">Point of Sale</button>
            <button class="tab-btn flex-1 py-3 px-4 text-sm font-medium rounded-lg transition-colors duration-300" data-tab="products">Products</button>
            <button class="tab-btn flex-1 py-3 px-4 text-sm font-medium rounded-lg transition-colors duration-300" data-tab="customers">Customers</button>
            <button class="tab-btn flex-1 py-3 px-4 text-sm font-medium rounded-lg transition-colors duration-300" data-tab="sales">Sales History</button>
            <button class="tab-btn flex-1 py-3 px-4 text-sm font-medium rounded-lg transition-colors duration-300" data-tab="reports">Reports</button>
            <button class="tab-btn flex-1 py-3 px-4 text-sm font-medium rounded-lg transition-colors duration-300" data-tab="settings">Settings</button>
        </div>

        <!-- Tab Content Containers -->
        <!-- POS Tab -->
        <div id="pos-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Product List -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Products</h2>
                    <input type="text" id="product-search" placeholder="Search products or scan barcode..." class="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-indigo-500 transition-colors duration-300 mb-4">
                    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 custom-scrollbar overflow-y-auto h-[600px] pr-2">
                        <!-- Product cards will be rendered here -->
                    </div>
                </div>

                <!-- Sales Cart -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Sales Cart</h2>
                    <div class="mb-4">
                        <label for="customer-select" class="block text-sm font-medium text-gray-700">Select Customer</label>
                        <select id="customer-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-lg shadow-sm">
                            <option value="">Walk-in Customer</option>
                        </select>
                    </div>
                    <div id="cart-list" class="space-y-4 mb-6 custom-scrollbar overflow-y-auto h-[400px] pr-2">
                        <!-- Cart items will be rendered here -->
                        <p id="empty-cart-message" class="text-center text-gray-500">Your cart is empty.</p>
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center text-xl font-bold mb-2">
                            <span>Subtotal:</span>
                            <span id="cart-subtotal-display">0.00 MMK</span>
                        </div>
                        <div class="mb-4">
                            <label for="discount-input" class="block text-sm font-medium text-gray-700">Discount (%)</label>
                            <input type="number" id="discount-input" value="0" min="0" max="100" class="w-full p-2 rounded-lg border-2" />
                        </div>
                        <div class="flex justify-between items-center text-2xl font-bold mb-4">
                            <span>Total:</span>
                            <span id="cart-total-display">0.00 MMK</span>
                        </div>
                        <div class="mb-4">
                            <label for="payment-method-select" class="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select id="payment-method-select" class="w-full p-2 rounded-lg border-2">
                                <option value="Cash">Cash</option>
                                <option value="Mobile Payment">Mobile Payment</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Card Payment">Card Payment</option>
                            </select>
                        </div>
                        <button id="process-sale-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 shadow-lg">Process Sale</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Manage Products</h2>
                <form id="product-form" class="space-y-4 mb-6">
                    <input type="hidden" id="product-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="product-name" class="w-full p-3 rounded-lg border-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Supplier Name</label>
                        <input type="text" id="product-supplier" class="w-full p-3 rounded-lg border-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Selling Price (MMK)</label>
                        <input type="number" id="product-price" class="w-full p-3 rounded-lg border-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Buying Price (MMK)</label>
                        <input type="number" id="product-buying-price" class="w-full p-3 rounded-lg border-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Stock Quantity</label>
                        <input type="number" id="product-stock" class="w-full p-3 rounded-lg border-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Barcode</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="product-barcode" class="w-full p-3 rounded-lg border-2" placeholder="Scan or enter barcode">
                            <button type="button" id="scan-barcode-btn" class="bg-indigo-500 text-white p-3 rounded-lg hover:bg-indigo-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                    <path d="M3.75 4.5a.75.75 0 00-.75.75v3h-.75a.75.75 0 000 1.5h.75v3h-.75a.75.75 0 000 1.5h.75v3a.75.75 0 00.75.75h3a.75.75 0 001.5 0v-.75h3v.75a.75.75 0 001.5 0v-.75h3v.75a.75.75 0 00.75-.75v-3h.75a.75.75 0 000-1.5h-.75v-3h.75a.75.75 0 000-1.5h-.75v-3a.75.75 0 00-.75-.75h-3a.75.75 0 00-1.5 0v.75h-3v-.75a.75.75 0 00-1.5 0v.75h-3v-.75a.75.75 0 00-.75.75z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Product Photo</label>
                        <input type="url" id="product-photo-url" class="w-full p-3 rounded-lg border-2" placeholder="Paste image URL here">
                        <div id="product-photo-drop-area" class="mt-2 flex justify-center items-center h-24 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer">
                            <p class="text-gray-500">Drag & Drop Image Here</p>
                            <input type="file" id="product-photo-upload" class="hidden" accept="image/*">
                        </div>
                        <img id="product-photo-preview" class="mt-4 w-32 h-32 object-contain rounded-lg shadow-md border" src="https://placehold.co/128x128/e5e7eb/4b5563?text=No+Image" alt="Product Photo Preview">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Save Product</button>
                </form>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-lg">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Photo</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Supplier</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Barcode</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Price (MMK)</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Buying Price</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body" class="divide-y divide-gray-200">
                            <!-- Product rows will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Manage Customers</h2>
                <form id="customer-form" class="space-y-4 mb-6">
                    <input type="hidden" id="customer-id">
                    <div><label class="block text-sm font-medium text-gray-700">Customer Name</label><input type="text" id="customer-name" class="w-full p-3 rounded-lg border-2" required></div>
                    <div><label class="block text-sm font-medium text-gray-700">Phone Number</label><input type="text" id="customer-phone" class="w-full p-3 rounded-lg border-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">City</label><input type="text" id="customer-city" class="w-full p-3 rounded-lg border-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Township</label><input type="text" id="customer-township" class="w-full p-3 rounded-lg border-2"></div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Save Customer</button>
                </form>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-lg">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Phone</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">City</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Township</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body" class="divide-y divide-gray-200">
                            <!-- Customer rows will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sales History Tab -->
        <div id="sales-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Sales History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-lg">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Customer</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Amount</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Discount</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Payment Method</th>
                                <th class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Items Sold</th>
                            </tr>
                        </thead>
                        <tbody id="sales-history-table-body" class="divide-y divide-gray-200">
                            <!-- Sales history will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Sales Reports</h2>
                <!-- Sales Summary Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
                    <div class="bg-indigo-500 text-white rounded-xl p-6 shadow-lg">
                        <p class="text-sm font-medium opacity-80">Today's Sales</p>
                        <div class="flex items-center justify-between">
                            <span id="today-sales-value" class="text-3xl font-bold mt-1">0.00 MMK</span>
                            <span id="today-sales-change" class="text-sm font-semibold p-1 rounded-full bg-white bg-opacity-20"></span>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">Total Sales</p>
                        <span id="total-sales-value" class="text-3xl font-bold text-gray-800 mt-1">0.00 MMK</span>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">Total Transactions</p>
                        <span id="total-transactions-value" class="text-3xl font-bold text-gray-800 mt-1">0</span>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">Average Transaction</p>
                        <span id="average-transaction-value" class="text-3xl font-bold text-gray-800 mt-1">0.00 MMK</span>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg col-span-1 md:col-span-2 border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">Highest Sales Days</p>
                        <ul id="highest-sales-days-list" class="mt-2 list-disc pl-5">
                            <li class="text-gray-600">No data available.</li>
                        </ul>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg col-span-1 md:col-span-2 border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">Monthly Sales</p>
                        <div class="mt-2">
                             <canvas id="monthly-sales-chart" class="h-48"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sales Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Line Chart -->
                    <div class="bg-gray-100 rounded-xl p-4 shadow-inner">
                        <h3 class="text-lg font-semibold mb-2">Weekly Sales Trend</h3>
                        <canvas id="sales-line-chart"></canvas>
                    </div>
                    <!-- Bar Chart -->
                    <div class="bg-gray-100 rounded-xl p-4 shadow-inner">
                        <h3 class="text-lg font-semibold mb-2">Sales by Category</h3>
                        <canvas id="sales-bar-chart"></canvas>
                    </div>
                    <!-- Pie Chart -->
                    <div class="bg-gray-100 rounded-xl p-4 shadow-inner">
                        <h3 class="text-lg font-semibold mb-2">Sales by Customer</h3>
                        <canvas id="sales-pie-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Company Settings</h2>
                <form id="settings-form" class="space-y-6 mb-6">
                    <!-- Company Info -->
                    <div>
                        <h3 class="text-xl font-semibold mb-2">Company Information</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Company Name</label>
                                <input type="text" id="company-name-input" class="w-full p-3 rounded-lg border-2" placeholder="e.g., Your Shop Name">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Company Logo URL</label>
                                <input type="url" id="company-logo-url-input" class="w-full p-3 rounded-lg border-2" placeholder="Paste a logo image URL here">
                                <p class="text-sm text-gray-500 mt-1">Or drag and drop an image file below.</p>
                                <div id="logo-drop-area" class="mt-2 flex justify-center items-center h-24 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer">
                                    <p class="text-gray-500">Drag & Drop Image Here</p>
                                    <input type="file" id="logo-upload-input" class="hidden" accept="image/*">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Storage Location -->
                    <div>
                        <h3 class="text-xl font-semibold mb-2">Data Storage Location</h3>
                        <p class="text-gray-600 text-sm mb-2">Choose where your data will be saved. Changing this will refresh the app with the data from the new location.</p>
                        <select id="data-storage-select" class="w-full p-3 rounded-lg border-2">
                            <option value="private">Private (My Data Only)</option>
                            <option value="public">Public (Shared with others)</option>
                        </select>
                    </div>

                    <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Save Settings</button>
                </form>
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-2">Current Settings Preview</h3>
                    <div class="bg-gray-50 p-4 rounded-lg flex items-center space-x-4 border border-gray-200">
                        <img id="logo-preview" src="https://placehold.co/60x60/888888/ffffff?text=Logo" alt="Company Logo" class="w-16 h-16 object-contain rounded-full shadow">
                        <h4 id="company-name-preview" class="text-lg font-bold">Your Company Name</h4>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- All Modals Container -->
<div id="modal-container" class="relative z-[100]">
    <!-- Generic Modal -->
    <div id="generic-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
        <div id="generic-modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Modal Title</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Modal Message.</p>
            <div id="modal-actions" class="flex justify-end space-x-2">
                <button id="modal-confirm-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">Confirm</button>
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md text-center modal-content">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Authentication Required</h3>
            <p class="text-gray-600 mb-6">You are not authenticated. Please sign in to access the application.</p>
            <p class="text-sm text-gray-500 mb-4">Signing in anonymously to initialize the app...</p>
            <div id="auth-loader" class="flex justify-center items-center space-x-2">
                <div class="h-4 w-4 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: -0.3s;"></div>
                <div class="h-4 w-4 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: -0.15s;"></div>
                <div class="h-4 w-4 bg-indigo-500 rounded-full animate-bounce"></div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="barcode-scanner-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg modal-content">
            <h3 class="text-xl font-bold mb-4">Scan Barcode</h3>
            <div id="interactive-reader" class="w-full h-64 bg-gray-200 rounded-lg overflow-hidden"></div>
            <p id="barcode-result" class="text-center text-sm text-gray-600 mt-2">Point your camera at a barcode.</p>
            <div class="flex justify-end mt-4">
                <button id="close-scanner-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 no-print">
        <div id="receipt-modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm modal-content">
            <div id="receipt-header" class="text-center mb-4">
                <img id="receipt-logo" src="" alt="Company Logo" class="h-16 mx-auto mb-2 object-contain" onerror="this.style.display='none'">
                <h4 id="receipt-company-name" class="text-lg font-bold"></h4>
            </div>
            <h3 class="text-xl font-bold text-center mb-4 border-b pb-2">SALES RECEIPT</h3>
            <div id="receipt-details" class="text-sm space-y-1 mb-4">
                <p><strong>Date:</strong> <span id="receipt-date"></span></p>
                <p><strong>Customer:</strong> <span id="receipt-customer"></span></p>
                <p><strong>Payment Method:</strong> <span id="receipt-payment-method"></span></p>
            </div>
            <div class="overflow-x-auto mb-4">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b-2">
                            <th class="text-left py-1">Item</th>
                            <th class="text-right py-1">Qty</th>
                            <th class="text-right py-1">Price</th>
                            <th class="text-right py-1">Total</th>
                        </tr>
                    </thead>
                    <tbody id="receipt-items-table">
                        <!-- Receipt items will be populated here -->
                    </tbody>
                </table>
            </div>
            <div class="text-right text-base font-semibold border-t-2 pt-2">
                <p>Subtotal: <span id="receipt-subtotal"></span></p>
                <p>Discount (<span id="receipt-discount-percent"></span>): <span id="receipt-discount-amount"></span></p>
            </div>
            <div class="text-right text-lg font-bold">
                Total: <span id="receipt-total"></span>
            </div>
            <div class="text-center mt-4 text-gray-500 text-xs">
                <p>Thank you for your business!</p>
            </div>
            <div class="mt-6 flex justify-end space-x-2 no-print">
                <button id="print-receipt-btn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">Print</button>
                <button id="close-receipt-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors">Close</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // Firebase CDN imports for a single-file application
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Global variables from the hosting environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firestore Collection Names
    const PRODUCTS_COLLECTION = 'products';
    const CUSTOMERS_COLLECTION = 'customers';
    const SALES_COLLECTION = 'sales';
    const SETTINGS_COLLECTION = 'settings';
    const SETTINGS_DOC_ID = 'company-profile';

    // Application state
    let app, db, auth, storage;
    let userProfile = null;
    let isAuthReady = false;
    let store = {
        products: [],
        customers: [],
        sales: [],
        cart: [],
        isImporting: false,
        settings: {
            companyName: 'Your Company',
            logoUrl: 'https://placehold.co/60x60/888888/ffffff?text=Logo',
            dataStorageLocation: 'private' // default value
        },
    };
    
    let unsubscribeProducts, unsubscribeCustomers, unsubscribeSales, unsubscribeSettings;

    // DOM Elements
    const elements = {
        appContainer: document.getElementById('app-container'),
        authModal: document.getElementById('auth-modal'),
        genericModal: document.getElementById('generic-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalMessage: document.getElementById('modal-message'),
        modalActions: document.getElementById('modal-actions'),
        modalConfirmBtn: document.getElementById('modal-confirm-btn'),
        modalCancelBtn: document.getElementById('modal-cancel-btn'),
        userDisplayName: document.getElementById('user-display-name'),
        productGrid: document.getElementById('product-grid'),
        productSearch: document.getElementById('product-search'),
        customerSelect: document.getElementById('customer-select'),
        cartList: document.getElementById('cart-list'),
        emptyCartMessage: document.getElementById('empty-cart-message'),
        cartSubtotalDisplay: document.getElementById('cart-subtotal-display'),
        discountInput: document.getElementById('discount-input'),
        cartTotalDisplay: document.getElementById('cart-total-display'),
        paymentMethodSelect: document.getElementById('payment-method-select'),
        processSaleBtn: document.getElementById('process-sale-btn'),
        productForm: document.getElementById('product-form'),
        productId: document.getElementById('product-id'),
        productName: document.getElementById('product-name'),
        productSupplier: document.getElementById('product-supplier'),
        productPrice: document.getElementById('product-price'),
        productBuyingPrice: document.getElementById('product-buying-price'),
        productStock: document.getElementById('product-stock'),
        productBarcode: document.getElementById('product-barcode'),
        productPhotoUrl: document.getElementById('product-photo-url'),
        productPhotoDropArea: document.getElementById('product-photo-drop-area'),
        productPhotoUpload: document.getElementById('product-photo-upload'),
        productPhotoPreview: document.getElementById('product-photo-preview'),
        scanBarcodeBtn: document.getElementById('scan-barcode-btn'),
        barcodeScannerModal: document.getElementById('barcode-scanner-modal'),
        interactiveReader: document.getElementById('interactive-reader'),
        barcodeResult: document.getElementById('barcode-result'),
        closeScannerBtn: document.getElementById('close-scanner-btn'),
        productTableBody: document.getElementById('product-table-body'),
        customerForm: document.getElementById('customer-form'),
        customerId: document.getElementById('customer-id'),
        customerName: document.getElementById('customer-name'),
        customerPhone: document.getElementById('customer-phone'),
        customerCity: document.getElementById('customer-city'),
        customerTownship: document.getElementById('customer-township'),
        customerTableBody: document.getElementById('customer-table-body'),
        salesHistoryTableBody: document.getElementById('sales-history-table-body'),
        tabButtons: document.querySelectorAll('.tab-btn'),
        tabContents: document.querySelectorAll('.tab-content'),
        receiptModal: document.getElementById('receipt-modal'),
        receiptModalContent: document.getElementById('receipt-modal-content'),
        receiptLogo: document.getElementById('receipt-logo'),
        receiptCompanyName: document.getElementById('receipt-company-name'),
        receiptDate: document.getElementById('receipt-date'),
        receiptCustomer: document.getElementById('receipt-customer'),
        receiptPaymentMethod: document.getElementById('receipt-payment-method'),
        receiptItemsTable: document.getElementById('receipt-items-table'),
        receiptSubtotal: document.getElementById('receipt-subtotal'),
        receiptDiscountPercent: document.getElementById('receipt-discount-percent'),
        receiptDiscountAmount: document.getElementById('receipt-discount-amount'),
        receiptTotal: document.getElementById('receipt-total'),
        printReceiptBtn: document.getElementById('print-receipt-btn'),
        closeReceiptBtn: document.getElementById('close-receipt-btn'),
        settingsForm: document.getElementById('settings-form'),
        companyNameInput: document.getElementById('company-name-input'),
        companyLogoUrlInput: document.getElementById('company-logo-url-input'),
        logoDropArea: document.getElementById('logo-drop-area'),
        logoUploadInput: document.getElementById('logo-upload-input'),
        logoPreview: document.getElementById('logo-preview'),
        companyNamePreview: document.getElementById('company-name-preview'),
        dataStorageSelect: document.getElementById('data-storage-select'),
        salesLineChart: null,
        salesBarChart: null,
        salesPieChart: null,
        // New elements for sales reports summary
        todaySalesValue: document.getElementById('today-sales-value'),
        todaySalesChange: document.getElementById('today-sales-change'),
        totalSalesValue: document.getElementById('total-sales-value'),
        totalTransactionsValue: document.getElementById('total-transactions-value'),
        averageTransactionValue: document.getElementById('average-transaction-value'),
        highestSalesDaysList: document.getElementById('highest-sales-days-list'),
        monthlySalesChart: null
    };

    // --- Modal Functionality ---
    const showModal = (title, message, showConfirm, confirmCallback, showCancel, cancelCallback) => {
        elements.modalTitle.textContent = title;
        elements.modalMessage.textContent = message;
        elements.genericModal.classList.remove('hidden');
        elements.modalConfirmBtn.classList.toggle('hidden', !showConfirm);
        elements.modalCancelBtn.classList.toggle('hidden', !showCancel);
        
        const handleConfirm = () => {
            if (confirmCallback) confirmCallback();
            hideModal();
        };

        const handleCancel = () => {
            if (cancelCallback) cancelCallback();
            hideModal();
        };

        elements.modalConfirmBtn.onclick = handleConfirm;
        elements.modalCancelBtn.onclick = handleCancel;
    };

    const hideModal = () => {
        elements.genericModal.classList.add('hidden');
        elements.modalConfirmBtn.onclick = null;
        elements.modalCancelBtn.onclick = null;
    };

    // --- Core UI Rendering Functions ---
    const renderProducts = (filter = '') => {
        elements.productGrid.innerHTML = '';
        let filteredProducts = store.products;
        if (filter) {
             filteredProducts = store.products.filter(p =>
                p.name.toLowerCase().includes(filter.toLowerCase()) || (p.barcode && p.barcode.includes(filter))
            );
        }

        if (filteredProducts.length === 0) {
            elements.productGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">No products found.</p>';
            return;
        }

        filteredProducts.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = `product-card bg-gray-100 p-4 rounded-xl shadow-md cursor-pointer transition-transform duration-200 ${product.stock <= 0 ? 'opacity-50 grayscale cursor-not-allowed' : ''}`;
            productCard.innerHTML = `
                <img src="${product.photoUrl || 'https://placehold.co/100x100/e5e7eb/4b5563?text=No+Photo'}" alt="${product.name}" class="w-full h-24 object-contain mb-2 rounded-lg">
                <h3 class="font-semibold text-lg truncate">${product.name}</h3>
                <p class="text-gray-600">Price: ${product.price} MMK</p>
                <p class="text-sm text-gray-500">Stock: ${product.stock}</p>
            `;
            if (product.stock > 0) {
                productCard.addEventListener('click', () => addToCart(product));
            }
            elements.productGrid.appendChild(productCard);
        });
    };

    const renderCustomerSelect = () => {
        elements.customerSelect.innerHTML = '<option value="">Walk-in Customer</option>';
        store.customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = customer.name;
            elements.customerSelect.appendChild(option);
        });
    };

    const renderCart = () => {
        elements.cartList.innerHTML = '';
        if (store.cart.length === 0) {
            elements.emptyCartMessage.classList.remove('hidden');
        } else {
            elements.emptyCartMessage.classList.add('hidden');
            store.cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'bg-gray-100 p-3 rounded-lg flex items-center justify-between shadow-sm';
                cartItem.innerHTML = `
                    <div class="flex-1 truncate">
                        <span class="font-medium">${item.name}</span>
                        <span class="text-sm text-gray-600">(${item.price} MMK x ${item.quantity})</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold">${(item.quantity * item.price).toFixed(2)} MMK</span>
                        <button class="remove-from-cart text-red-500 hover:text-red-700 transition-colors" data-product-id="${item.id}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
                elements.cartList.appendChild(cartItem);
            });
        }
        updateCartTotals();
    };

    const updateCartTotals = () => {
        const subtotal = store.cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
        const discountPercentage = parseFloat(elements.discountInput.value) || 0;
        const discountAmount = subtotal * (discountPercentage / 100);
        const total = subtotal - discountAmount;
        
        elements.cartSubtotalDisplay.textContent = `${subtotal.toFixed(2)} MMK`;
        elements.cartTotalDisplay.textContent = `${total.toFixed(2)} MMK`;
    };

    const renderProductTable = () => {
        elements.productTableBody.innerHTML = '';
        store.products.forEach(product => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="py-3 px-6 whitespace-nowrap"><img src="${product.photoUrl || 'https://placehold.co/40x40/e5e7eb/4b5563?text=No+Photo'}" alt="${product.name}" class="w-10 h-10 object-contain rounded-full"></td>
                <td class="py-3 px-6 whitespace-nowrap">${product.name}</td>
                <td class="py-3 px-6 whitespace-nowrap">${product.supplier || 'N/A'}</td>
                <td class="py-3 px-6 whitespace-nowrap">${product.barcode || 'N/A'}</td>
                <td class="py-3 px-6 whitespace-nowrap">${product.price.toFixed(2)}</td>
                <td class="py-3 px-6 whitespace-nowrap">${product.buyingPrice.toFixed(2)}</td>
                <td class="py-3 px-6 whitespace-nowrap">${product.stock}</td>
                <td class="py-3 px-6 whitespace-nowrap">
                    <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium mr-2" data-id="${product.id}">Edit</button>
                    <button class="delete-btn text-red-500 hover:text-red-700 font-medium" data-id="${product.id}">Delete</button>
                </td>
            `;
            elements.productTableBody.appendChild(row);
        });
    };

    const renderCustomerTable = () => {
        elements.customerTableBody.innerHTML = '';
        store.customers.forEach(customer => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="py-3 px-6 whitespace-nowrap">${customer.name}</td>
                <td class="py-3 px-6 whitespace-nowrap">${customer.phone || 'N/A'}</td>
                <td class="py-3 px-6 whitespace-nowrap">${customer.city || 'N/A'}</td>
                <td class="py-3 px-6 whitespace-nowrap">${customer.township || 'N/A'}</td>
                <td class="py-3 px-6 whitespace-nowrap">
                    <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium mr-2" data-id="${customer.id}">Edit</button>
                    <button class="delete-btn text-red-500 hover:text-red-700 font-medium" data-id="${customer.id}">Delete</button>
                </td>
            `;
            elements.customerTableBody.appendChild(row);
        });
    };

    const renderSalesHistoryTable = () => {
        elements.salesHistoryTableBody.innerHTML = '';
        store.sales.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
        store.sales.forEach(sale => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            const date = sale.timestamp.toDate().toLocaleDateString();
            const time = sale.timestamp.toDate().toLocaleTimeString();
            row.innerHTML = `
                <td class="py-3 px-6 whitespace-nowrap">${date} ${time}</td>
                <td class="py-3 px-6 whitespace-nowrap">${sale.customerName}</td>
                <td class="py-3 px-6 whitespace-nowrap">${sale.total.toFixed(2)} MMK</td>
                <td class="py-3 px-6 whitespace-nowrap">${sale.discount}%</td>
                <td class="py-3 px-6 whitespace-nowrap">${sale.paymentMethod}</td>
                <td class="py-3 px-6 whitespace-nowrap">${sale.items.map(item => `${item.name} x${item.quantity}`).join(', ')}</td>
            `;
            elements.salesHistoryTableBody.appendChild(row);
        });
    };

    // --- Data Handling & Persistence ---
    const getFirestorePath = (collectionName) => {
        const userId = auth.currentUser?.uid || 'anonymous';
        const isPublic = store.settings.dataStorageLocation === 'public';
        if (isPublic) {
            return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
        } else {
            return collection(db, 'artifacts', appId, 'users', userId, collectionName);
        }
    };

    const addToCart = (product) => {
        const existingItem = store.cart.find(item => item.id === product.id);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            store.cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                quantity: 1,
            });
        }
        renderCart();
    };

    const removeFromCart = (productId) => {
        const itemIndex = store.cart.findIndex(item => item.id === productId);
        if (itemIndex > -1) {
            store.cart.splice(itemIndex, 1);
            renderCart();
        }
    };

    const handleProcessSale = async () => {
        if (store.cart.length === 0) {
            showModal('Cart is Empty', 'Please add products to the cart before processing a sale.', false, null, true, hideModal);
            return;
        }

        const subtotal = store.cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
        const discountPercentage = parseFloat(elements.discountInput.value) || 0;
        const discountAmount = subtotal * (discountPercentage / 100);
        const total = subtotal - discountAmount;

        const saleData = {
            timestamp: new Date(),
            customerId: elements.customerSelect.value || null,
            customerName: elements.customerSelect.options[elements.customerSelect.selectedIndex].text,
            items: store.cart.map(item => ({
                id: item.id,
                name: item.name,
                quantity: item.quantity,
                price: item.price
            })),
            subtotal: subtotal,
            discount: discountPercentage,
            total: total,
            paymentMethod: elements.paymentMethodSelect.value,
        };

        // Update product stock in Firestore
        const batch = db.batch();
        for (const item of store.cart) {
            const productRef = doc(getFirestorePath(PRODUCTS_COLLECTION), item.id);
            const product = store.products.find(p => p.id === item.id);
            if (product) {
                batch.update(productRef, { stock: product.stock - item.quantity });
            }
        }
        await batch.commit();

        // Add sale to Firestore
        await addDoc(getFirestorePath(SALES_COLLECTION), saleData);

        // Render the receipt and show the modal
        renderReceipt(saleData);

        // Clear the cart after a successful sale
        store.cart = [];
        elements.discountInput.value = 0;
        renderCart();
    };
    
    // --- Receipt Functions ---
    const renderReceipt = (sale) => {
        elements.receiptLogo.src = store.settings.logoUrl;
        elements.receiptCompanyName.textContent = store.settings.companyName;
        elements.receiptDate.textContent = new Date(sale.timestamp.seconds * 1000).toLocaleString();
        elements.receiptCustomer.textContent = sale.customerName;
        elements.receiptPaymentMethod.textContent = sale.paymentMethod;
        
        elements.receiptItemsTable.innerHTML = '';
        sale.items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="text-left py-1">${item.name}</td>
                <td class="text-right py-1">${item.quantity}</td>
                <td class="text-right py-1">${item.price.toFixed(2)}</td>
                <td class="text-right py-1">${(item.quantity * item.price).toFixed(2)}</td>
            `;
            elements.receiptItemsTable.appendChild(row);
        });
        
        elements.receiptSubtotal.textContent = `${sale.subtotal.toFixed(2)} MMK`;
        elements.receiptDiscountPercent.textContent = `${sale.discount}%`;
        const discountAmount = sale.subtotal * (sale.discount / 100);
        elements.receiptDiscountAmount.textContent = `${discountAmount.toFixed(2)} MMK`;
        elements.receiptTotal.textContent = `${sale.total.toFixed(2)} MMK`;

        elements.receiptModal.classList.remove('hidden');
    };

    const handlePrintReceipt = () => {
        window.print();
    };

    // --- Charting Functions ---
    const renderSalesCharts = () => {
        if (!store.sales.length) {
            if (elements.salesLineChart) elements.salesLineChart.destroy();
            if (elements.salesBarChart) elements.salesBarChart.destroy();
            if (elements.salesPieChart) elements.salesPieChart.destroy();
            if (elements.monthlySalesChart) elements.monthlySalesChart.destroy();
            return;
        }
        renderSalesLineChart();
        renderSalesBarChart();
        renderSalesPieChart();
        renderMonthlySalesChart();
    };

    const renderSalesLineChart = () => {
        if (elements.salesLineChart) elements.salesLineChart.destroy();

        // Aggregate sales by date
        const salesByDate = {};
        store.sales.forEach(sale => {
            const date = new Date(sale.timestamp.toDate()).toISOString().split('T')[0];
            salesByDate[date] = (salesByDate[date] || 0) + sale.total;
        });

        const labels = Object.keys(salesByDate).sort();
        const data = labels.map(date => salesByDate[date]);

        const ctx = document.getElementById('sales-line-chart').getContext('2d');
        elements.salesLineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Sales (MMK)',
                    data: data,
                    borderColor: 'rgb(79, 70, 229)',
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    tension: 0.4,
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    };

    const renderSalesBarChart = () => {
        if (elements.salesBarChart) elements.salesBarChart.destroy();

        // Aggregate sales by product category (or just product name for simplicity)
        const salesByCategory = {};
        store.sales.forEach(sale => {
            sale.items.forEach(item => {
                salesByCategory[item.name] = (salesByCategory[item.name] || 0) + (item.quantity * item.price);
            });
        });

        const labels = Object.keys(salesByCategory);
        const data = labels.map(label => salesByCategory[label]);

        const ctx = document.getElementById('sales-bar-chart').getContext('2d');
        elements.salesBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sales (MMK)',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    };

    const renderSalesPieChart = () => {
        if (elements.salesPieChart) elements.salesPieChart.destroy();

        // Aggregate sales by customer
        const salesByCustomer = {};
        store.sales.forEach(sale => {
            const customerName = sale.customerName === "Walk-in Customer" ? "Walk-in" : sale.customerName;
            salesByCustomer[customerName] = (salesByCustomer[customerName] || 0) + sale.total;
        });

        const labels = Object.keys(salesByCustomer);
        const data = labels.map(label => salesByCustomer[label]);
        const colors = labels.map(() => `hsl(${Math.random() * 360}, 70%, 50%)`);

        const ctx = document.getElementById('sales-pie-chart').getContext('2d');
        elements.salesPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sales by Customer',
                    data: data,
                    backgroundColor: colors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
            }
        });
    };

    const renderMonthlySalesChart = () => {
        if (elements.monthlySalesChart) elements.monthlySalesChart.destroy();

        const monthlySales = {};
        store.sales.forEach(sale => {
            const date = new Date(sale.timestamp.toDate());
            const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            monthlySales[monthYear] = (monthlySales[monthYear] || 0) + sale.total;
        });

        const sortedMonths = Object.keys(monthlySales).sort();
        const labels = sortedMonths.map(month => {
            const [year, monthNum] = month.split('-');
            const date = new Date(year, monthNum - 1);
            return date.toLocaleString('default', { month: 'short', year: 'numeric' });
        });
        const data = sortedMonths.map(month => monthlySales[month]);

        const ctx = document.getElementById('monthly-sales-chart').getContext('2d');
        elements.monthlySalesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Monthly Sales (MMK)',
                    data: data,
                    backgroundColor: 'rgb(54, 162, 235)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    };

    const calculateAndRenderSalesSummary = () => {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);

        const todaySales = store.sales.filter(sale => {
            const saleDate = sale.timestamp.toDate();
            return saleDate.getDate() === today.getDate() &&
                   saleDate.getMonth() === today.getMonth() &&
                   saleDate.getFullYear() === today.getFullYear();
        }).reduce((sum, sale) => sum + sale.total, 0);

        const yesterdaySales = store.sales.filter(sale => {
            const saleDate = sale.timestamp.toDate();
            return saleDate.getDate() === yesterday.getDate() &&
                   saleDate.getMonth() === yesterday.getMonth() &&
                   saleDate.getFullYear() === yesterday.getFullYear();
        }).reduce((sum, sale) => sum + sale.total, 0);

        let totalSales = store.sales.reduce((sum, sale) => sum + sale.total, 0);
        let totalTransactions = store.sales.length;
        let averageTransaction = totalTransactions > 0 ? totalSales / totalTransactions : 0;

        elements.todaySalesValue.textContent = `${todaySales.toFixed(2)} MMK`;
        let changePercent = (yesterdaySales > 0) ? ((todaySales - yesterdaySales) / yesterdaySales) * 100 : (todaySales > 0 ? 100 : 0);
        elements.todaySalesChange.textContent = `${changePercent.toFixed(1)}%`;
        elements.todaySalesChange.classList.toggle('bg-red-500', changePercent < 0);
        elements.todaySalesChange.classList.toggle('bg-green-500', changePercent >= 0);

        elements.totalSalesValue.textContent = `${totalSales.toFixed(2)} MMK`;
        elements.totalTransactionsValue.textContent = totalTransactions.toString();
        elements.averageTransactionValue.textContent = `${averageTransaction.toFixed(2)} MMK`;

        // Calculate highest sales days
        const salesByDay = {};
        store.sales.forEach(sale => {
            const date = new Date(sale.timestamp.toDate()).toDateString();
            salesByDay[date] = (salesByDay[date] || 0) + sale.total;
        });
        const sortedSalesDays = Object.entries(salesByDay).sort(([, a], [, b]) => b - a);
        elements.highestSalesDaysList.innerHTML = '';
        if (sortedSalesDays.length === 0) {
            elements.highestSalesDaysList.innerHTML = '<li class="text-gray-600">No data available.</li>';
        } else {
            sortedSalesDays.slice(0, 3).forEach(([date, total]) => {
                const li = document.createElement('li');
                li.className = 'text-gray-600';
                li.textContent = `${date}: ${total.toFixed(2)} MMK`;
                elements.highestSalesDaysList.appendChild(li);
            });
        }
    };

    // --- Tab Switching ---
    elements.tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            elements.tabButtons.forEach(btn => btn.classList.remove('active-tab', 'text-white'));
            button.classList.add('active-tab', 'text-white');
            elements.tabContents.forEach(content => content.classList.add('hidden'));
            const tabId = button.getAttribute('data-tab');
            document.getElementById(tabId + '-tab').classList.remove('hidden');
        });
    });

    // --- Barcode Scanner Logic ---
    let barcodeScannerRunning = false;
    const startBarcodeScanner = () => {
        if (barcodeScannerRunning) return;
        elements.barcodeScannerModal.classList.remove('hidden');
        barcodeScannerRunning = true;
        
        Quagga.init({
            inputStream : {
              name : "Live",
              type : "LiveStream",
              target: elements.interactiveReader,
              constraints: {
                  width: 640,
                  height: 480,
                  facingMode: "environment" // use rear camera
              },
            },
            decoder : {
              readers : ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"]
            }
        }, function(err) {
            if (err) {
                console.error(err);
                elements.barcodeResult.textContent = "Error: " + err.message;
                return;
            }
            Quagga.start();
        });

        Quagga.onDetected(data => {
            const code = data.codeResult.code;
            if (code) {
                elements.productBarcode.value = code;
                elements.barcodeResult.textContent = `Scanned: ${code}`;
                stopBarcodeScanner();
            }
        });

        elements.closeScannerBtn.addEventListener('click', stopBarcodeScanner, { once: true });
    };

    const stopBarcodeScanner = () => {
        if (!barcodeScannerRunning) return;
        Quagga.stop();
        elements.barcodeScannerModal.classList.add('hidden');
        barcodeScannerRunning = false;
    };

    // --- Main Logic & Event Handlers ---
    const setupEventListeners = () => {
        // POS search
        elements.productSearch.addEventListener('input', (e) => {
            renderProducts(e.target.value);
        });
        
        // Discount input change
        elements.discountInput.addEventListener('input', updateCartTotals);

        // Add/Edit Product
        elements.productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = elements.productId.value;
            const data = {
                name: elements.productName.value,
                supplier: elements.productSupplier.value,
                price: parseFloat(elements.productPrice.value),
                buyingPrice: parseFloat(elements.productBuyingPrice.value),
                stock: parseInt(elements.productStock.value, 10),
                barcode: elements.productBarcode.value || null,
                photoUrl: elements.productPhotoUrl.value || null,
            };

            try {
                if (id) {
                    await updateDoc(doc(getFirestorePath(PRODUCTS_COLLECTION), id), data);
                } else {
                    await addDoc(getFirestorePath(PRODUCTS_COLLECTION), data);
                }
                showModal('Success', 'Product saved successfully!', false, null, true, hideModal);
                elements.productForm.reset();
                elements.productPhotoPreview.src = 'https://placehold.co/128x128/e5e7eb/4b5563?text=No+Image';
            } catch (error) {
                console.error("Error saving product:", error);
                showModal('Error', 'Failed to save product. Please try again.', false, null, true, hideModal);
            }
        });
        
        // Scan barcode button
        elements.scanBarcodeBtn.addEventListener('click', startBarcodeScanner);

        // Edit/Delete Product from table
        elements.productTableBody.addEventListener('click', async (e) => {
            const id = e.target.getAttribute('data-id');
            if (e.target.classList.contains('edit-btn')) {
                const product = store.products.find(p => p.id === id);
                if (product) {
                    elements.productId.value = product.id;
                    elements.productName.value = product.name;
                    elements.productSupplier.value = product.supplier || '';
                    elements.productPrice.value = product.price;
                    elements.productBuyingPrice.value = product.buyingPrice;
                    elements.productStock.value = product.stock;
                    elements.productBarcode.value = product.barcode || '';
                    elements.productPhotoUrl.value = product.photoUrl || '';
                    elements.productPhotoPreview.src = product.photoUrl || 'https://placehold.co/128x128/e5e7eb/4b5563?text=No+Image';
                    document.querySelector('[data-tab="products"]').click();
                }
            } else if (e.target.classList.contains('delete-btn')) {
                showModal('Confirm Deletion', 'Are you sure you want to delete this product? This action cannot be undone.', true, async () => {
                    try {
                        await deleteDoc(doc(getFirestorePath(PRODUCTS_COLLECTION), id));
                        showModal('Success', 'Product deleted successfully!', false, null, true, hideModal);
                    } catch (error) {
                        console.error("Error deleting product:", error);
                        showModal('Error', 'Failed to delete product. Please try again.', false, null, true, hideModal);
                    }
                }, true, hideModal);
            }
        });

        // Add/Edit Customer
        elements.customerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = elements.customerId.value;
            const data = {
                name: elements.customerName.value,
                phone: elements.customerPhone.value,
                city: elements.customerCity.value,
                township: elements.customerTownship.value,
            };

            try {
                if (id) {
                    await updateDoc(doc(getFirestorePath(CUSTOMERS_COLLECTION), id), data);
                } else {
                    await addDoc(getFirestorePath(CUSTOMERS_COLLECTION), data);
                }
                showModal('Success', 'Customer saved successfully!', false, null, true, hideModal);
                elements.customerForm.reset();
            } catch (error) {
                console.error("Error saving customer:", error);
                showModal('Error', 'Failed to save customer. Please try again.', false, null, true, hideModal);
            }
        });

        // Edit/Delete Customer from table
        elements.customerTableBody.addEventListener('click', async (e) => {
            const id = e.target.getAttribute('data-id');
            if (e.target.classList.contains('edit-btn')) {
                const customer = store.customers.find(c => c.id === id);
                if (customer) {
                    elements.customerId.value = customer.id;
                    elements.customerName.value = customer.name;
                    elements.customerPhone.value = customer.phone;
                    elements.customerCity.value = customer.city;
                    elements.customerTownship.value = customer.township;
                    document.querySelector('[data-tab="customers"]').click();
                }
            } else if (e.target.classList.contains('delete-btn')) {
                showModal('Confirm Deletion', 'Are you sure you want to delete this customer? This action cannot be undone.', true, async () => {
                    try {
                        await deleteDoc(doc(getFirestorePath(CUSTOMERS_COLLECTION), id));
                        showModal('Success', 'Customer deleted successfully!', false, null, true, hideModal);
                    } catch (error) {
                        console.error("Error deleting customer:", error);
                        showModal('Error', 'Failed to delete customer. Please try again.', false, null, true, hideModal);
                    }
                }, true, hideModal);
            }
        });

        // Remove from cart
        elements.cartList.addEventListener('click', (e) => {
            if (e.target.closest('.remove-from-cart')) {
                const productId = e.target.closest('.remove-from-cart').getAttribute('data-product-id');
                removeFromCart(productId);
            }
        });

        // Process Sale
        elements.processSaleBtn.addEventListener('click', handleProcessSale);

        // Receipt modal buttons
        elements.printReceiptBtn.addEventListener('click', handlePrintReceipt);
        elements.closeReceiptBtn.addEventListener('click', () => elements.receiptModal.classList.add('hidden'));

        // Settings Form
        elements.settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const settingsData = {
                    companyName: elements.companyNameInput.value,
                    logoUrl: elements.companyLogoUrlInput.value,
                    dataStorageLocation: elements.dataStorageSelect.value,
                };
                const userId = auth.currentUser?.uid;
                if (!userId) throw new Error("User not authenticated.");

                const settingsRef = doc(db, 'artifacts', appId, 'users', userId, SETTINGS_COLLECTION, SETTINGS_DOC_ID);
                await setDoc(settingsRef, settingsData);
                showModal('Success', 'Company settings saved!', false, null, true, hideModal);
            } catch (error) {
                console.error("Error saving settings:", error);
                showModal('Error', 'Failed to save settings. ' + error.message, false, null, true, hideModal);
            }
        });
        
        // Data Storage Select change handler
        elements.dataStorageSelect.addEventListener('change', (e) => {
            store.settings.dataStorageLocation = e.target.value;
            // Unsubscribe from old listeners and subscribe to new ones
            if (isAuthReady) {
                unsubscribeDataListeners();
                setupDataListeners();
            }
        });

        // Logo upload functionality
        elements.logoDropArea.addEventListener('click', () => elements.logoUploadInput.click());
        elements.logoUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) { // 2MB limit
                showModal('File too large', 'Please upload an image smaller than 2MB.', false, null, true, hideModal);
                return;
            }

            try {
                showModal('Uploading...', 'Please wait while your logo is being uploaded.', false, null, false);
                const userId = auth.currentUser?.uid;
                const storageRef = ref(storage, `logos/${userId}/${file.name}`);
                await uploadBytes(storageRef, file);
                const logoUrl = await getDownloadURL(storageRef);
                elements.companyLogoUrlInput.value = logoUrl;
                elements.logoPreview.src = logoUrl;
                hideModal();
                showModal('Success', 'Logo uploaded successfully!', false, null, true, hideModal);
            } catch (error) {
                console.error("Error uploading logo:", error);
                hideModal();
                showModal('Error', 'Failed to upload logo. Please try again.', false, null, true, hideModal);
            }
        });
        
        elements.companyLogoUrlInput.addEventListener('input', () => {
            elements.logoPreview.src = elements.companyLogoUrlInput.value || 'https://placehold.co/60x60/888888/ffffff?text=Logo';
        });

        // Product Photo upload functionality
        elements.productPhotoDropArea.addEventListener('click', () => elements.productPhotoUpload.click());
        elements.productPhotoUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) { // 2MB limit
                showModal('File too large', 'Please upload an image smaller than 2MB.', false, null, true, hideModal);
                return;
            }

            try {
                showModal('Uploading...', 'Please wait while the photo is being uploaded.', false, null, false);
                const userId = auth.currentUser?.uid;
                const storageRef = ref(storage, `product_photos/${userId}/${file.name}`);
                await uploadBytes(storageRef, file);
                const photoUrl = await getDownloadURL(storageRef);
                elements.productPhotoUrl.value = photoUrl;
                elements.productPhotoPreview.src = photoUrl;
                hideModal();
                showModal('Success', 'Product photo uploaded successfully!', false, null, true, hideModal);
            } catch (error) {
                console.error("Error uploading photo:", error);
                hideModal();
                showModal('Error', 'Failed to upload photo. Please try again.', false, null, true, hideModal);
            }
        });
        elements.productPhotoUrl.addEventListener('input', (e) => {
            elements.productPhotoPreview.src = e.target.value || 'https://placehold.co/128x128/e5e7eb/4b5563?text=No+Image';
        });
    };
    
    // --- Firestore Listeners Management ---
    const unsubscribeDataListeners = () => {
        if (unsubscribeProducts) unsubscribeProducts();
        if (unsubscribeCustomers) unsubscribeCustomers();
        if (unsubscribeSales) unsubscribeSales();
    };

    const setupDataListeners = () => {
        unsubscribeDataListeners(); // Unsubscribe from previous collections

        // Products Listener
        unsubscribeProducts = onSnapshot(getFirestorePath(PRODUCTS_COLLECTION), (snapshot) => {
            store.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderProducts();
            renderProductTable();
        });

        // Customers Listener
        unsubscribeCustomers = onSnapshot(getFirestorePath(CUSTOMERS_COLLECTION), (snapshot) => {
            store.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCustomerSelect();
            renderCustomerTable();
        });

        // Sales Listener
        unsubscribeSales = onSnapshot(getFirestorePath(SALES_COLLECTION), (snapshot) => {
            store.sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSalesHistoryTable();
            calculateAndRenderSalesSummary();
            renderSalesCharts();
        });
    };

    const setupSettingsListener = (userId) => {
        const settingsRef = doc(db, 'artifacts', appId, 'users', userId, SETTINGS_COLLECTION, SETTINGS_DOC_ID);
        unsubscribeSettings = onSnapshot(settingsRef, (docSnap) => {
            if (docSnap.exists()) {
                const newSettings = docSnap.data();
                // Check if the data storage location has changed
                if (store.settings.dataStorageLocation !== newSettings.dataStorageLocation) {
                    store.settings = newSettings;
                    // Re-setup data listeners with the new path
                    setupDataListeners();
                } else {
                    store.settings = newSettings;
                }
            }
            // Update UI with loaded/updated settings
            elements.companyNameInput.value = store.settings.companyName;
            elements.companyLogoUrlInput.value = store.settings.logoUrl;
            elements.logoPreview.src = store.settings.logoUrl;
            elements.companyNamePreview.textContent = store.settings.companyName;
            elements.dataStorageSelect.value = store.settings.dataStorageLocation;
        }, (error) => {
            console.error("Error fetching settings:", error);
        });
    };

    // --- Firebase Initialization & Authentication ---
    const initFirebase = async () => {
        try {
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing.");
                showModal('Configuration Error', 'Firebase configuration is not available. Please contact support.', false, null, true, hideModal);
                return;
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userProfile = user;
                    const userId = user.uid;
                    elements.userDisplayName.textContent = `User: ${userId.substring(0, 8)}`;
                    elements.authModal.classList.add('hidden');
                    elements.appContainer.classList.remove('hidden');
                    isAuthReady = true;
                    // Set up the settings listener first, which will in turn trigger data listeners
                    setupSettingsListener(userId);
                } else {
                    elements.authModal.classList.remove('hidden');
                    elements.appContainer.classList.add('hidden');
                    isAuthReady = false;
                    unsubscribeDataListeners();
                    if (unsubscribeSettings) unsubscribeSettings();
                }
            });

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

        } catch (error) {
            console.error("Firebase init failed:", error);
            showModal('Authentication Failed', 'Unable to authenticate. ' + error.message, false, null, true, hideModal);
        }
    };

    // Initialize the application
    window.onload = () => {
        initFirebase();
        setupEventListeners();
    };
</script>

</body>
</html>
