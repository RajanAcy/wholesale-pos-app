<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wholesale POS - Local Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            min-height: 100vh;
        }

        .active-tab {
            background-color: #4f46e5;
            color: white;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px 3px rgba(0, 0, 0, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 p-8 flex flex-col items-center">

    <!-- Main Application Container -->
    <div id="appContainer" class="bg-white rounded-3xl shadow-xl w-full max-w-7xl overflow-hidden p-6 relative">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 sm:mb-0">Wholesale POS</h1>
            <nav id="navTabs" class="flex space-x-2 sm:space-x-4">
                <button data-tab="pos" class="px-4 py-2 rounded-full font-medium text-sm sm:text-base transition-colors duration-200">POS</button>
                <button data-tab="inventory" class="px-4 py-2 rounded-full font-medium text-sm sm:text-base transition-colors duration-200">Inventory</button>
                <button data-tab="customers" class="px-4 py-2 rounded-full font-medium text-sm sm:text-base transition-colors duration-200">Customers</button>
                <button data-tab="reports" class="px-4 py-2 rounded-full font-medium text-sm sm:text-base transition-colors duration-200">Reports</button>
                <button data-tab="settings" class="px-4 py-2 rounded-full font-medium text-sm sm:text-base transition-colors duration-200">Settings</button>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main id="contentArea">
            <!-- POS Section -->
            <section id="posSection" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Products Panel -->
                <div class="lg:col-span-2 bg-gray-50 p-4 rounded-xl shadow-inner">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Products</h2>
                        <div class="flex items-center space-x-2 mt-2 sm:mt-0 w-full sm:w-auto">
                            <input id="productSearch" type="text" placeholder="Search products..." class="w-full sm:w-auto p-2 border rounded-full text-sm">
                            <button id="cartCheckoutBtn" class="bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M3 1a1 1 0 000 2h18a1 1 0 000-2H3zM3 4a1 1 0 000 2h18a1 1 0 000-2H3zM3 7a1 1 0 000 2h18a1 1 0 000-2H3zM3 10a1 1 0 000 2h18a1 1 0 000-2H3z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto h-[50vh] custom-scrollbar">
                        <!-- Product cards will be rendered here -->
                    </div>
                </div>
                <!-- Cart Panel -->
                <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Cart</h2>
                    <select id="customerSelect" class="w-full p-2 mb-4 border rounded-lg text-sm">
                        <option value="">Select Customer (Optional)</option>
                    </select>
                    <div id="cartItems" class="overflow-y-auto h-[35vh] custom-scrollbar">
                        <!-- Cart items will be rendered here -->
                    </div>
                    <div class="mt-4 pt-4 border-t-2 border-gray-200">
                        <div class="flex justify-between font-bold text-gray-700 text-lg">
                            <span>Total:</span>
                            <span id="cartTotal">$0.00</span>
                        </div>
                    </div>
                    <button id="processSaleBtn" class="w-full mt-4 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition-colors duration-200">Process Sale</button>
                </div>
            </section>

            <!-- Inventory Section -->
            <section id="inventorySection" class="tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Product Inventory</h2>
                    <div class="flex space-x-2 mt-2 sm:mt-0">
                        <button id="importBtn" class="bg-green-500 text-white px-4 py-2 rounded-full text-sm hover:bg-green-600 transition-colors duration-200">Import CSV</button>
                        <button id="addProductBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-700 transition-colors duration-200">Add Product</button>
                    </div>
                </div>
                <div id="productTableContainer" class="bg-gray-50 p-4 rounded-xl shadow-inner overflow-x-auto">
                    <!-- Product table will be rendered here -->
                </div>
            </section>

            <!-- Customers Section -->
            <section id="customersSection" class="tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Customer List</h2>
                    <button id="addCustomerBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm mt-2 sm:mt-0 hover:bg-indigo-700 transition-colors duration-200">Add Customer</button>
                </div>
                <div id="customerTableContainer" class="bg-gray-50 p-4 rounded-xl shadow-inner overflow-x-auto">
                    <!-- Customer table will be rendered here -->
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reportsSection" class="tab-content hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Reports</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-200 p-4 rounded-xl shadow-md text-center">
                        <p class="text-sm font-medium text-blue-800">Total Sales</p>
                        <p id="totalSales" class="text-2xl font-bold text-blue-900 mt-1">$0.00</p>
                    </div>
                    <div class="bg-green-200 p-4 rounded-xl shadow-md text-center">
                        <p class="text-sm font-medium text-green-800">Total Revenue</p>
                        <p id="totalRevenue" class="text-2xl font-bold text-green-900 mt-1">$0.00</p>
                    </div>
                    <div class="bg-yellow-200 p-4 rounded-xl shadow-md text-center">
                        <p class="text-sm font-medium text-yellow-800">Total Profit</p>
                        <p id="totalProfit" class="text-2xl font-bold text-yellow-900 mt-1">$0.00</p>
                    </div>
                    <div class="bg-red-200 p-4 rounded-xl shadow-md text-center">
                        <p class="text-sm font-medium text-red-800">Total Cost</p>
                        <p id="totalCost" class="text-2xl font-bold text-red-900 mt-1">$0.00</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Sales History</h3>
                        <div id="salesHistoryTableContainer" class="overflow-x-auto">
                            <!-- Sales history table will be rendered here -->
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Top Selling Products</h3>
                        <div id="topSellingProductsContainer" class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="py-3 px-6 rounded-tl-lg">Product Name</th>
                                        <th scope="col" class="py-3 px-6">Quantity Sold</th>
                                        <th scope="col" class="py-3 px-6 rounded-tr-lg">Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="topSellingProductsTableBody">
                                    <!-- Top selling products will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settingsSection" class="tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Settings</h2>
                    <div class="flex space-x-2 mt-2 sm:mt-0">
                        <button id="exportAllDataBtn" class="bg-blue-500 text-white px-4 py-2 rounded-full text-sm hover:bg-blue-600 transition-colors duration-200">Export All Data</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">API Information</h3>
                        <p class="text-sm text-gray-600 mb-2">API is used for AI-powered features. To use the app with AI features, please set up API credentials by clicking the button below.</p>
                        <p class="text-sm font-bold text-gray-700">No API key is required to use this app.</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Admin Panel</h3>
                        <p class="text-sm text-gray-600">The application is currently running in Admin mode, so all features are enabled. This is the default for local development.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Generic Modal for Add/Edit -->
    <div id="genericModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md text-center">
            <h3 id="notificationTitle" class="text-xl font-bold text-gray-800 mb-2"></h3>
            <p id="notificationMessage" class="text-gray-600 mb-4"></p>
            <div id="notificationActions" class="flex justify-center space-x-4">
                <button id="notificationPrimaryBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition-colors duration-200">OK</button>
                <button id="notificationSecondaryBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-full hover:bg-gray-400 transition-colors duration-200">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div id="importModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Import CSV</h3>
                <button id="closeImportModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
            </div>
            <div class="modal-content">
                <p class="text-gray-600 mb-4">Select the type of data you want to import and choose a CSV file. The file must have the correct headers.</p>
                <div class="space-y-4">
                    <div>
                        <label for="importType" class="block text-sm font-medium text-gray-700">Data Type</label>
                        <select id="importType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="products">Products</option>
                            <option value="customers">Customers</option>
                        </select>
                    </div>
                    <div>
                        <label for="importFile" class="block text-sm font-medium text-gray-700">CSV File</label>
                        <input type="file" id="importFile" accept=".csv" class="mt-1 block w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="confirmImportBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition-colors duration-200">Import</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ====================================================================================
        // IMPORTANT: TO RUN LOCALLY, YOU MUST PROVIDE YOUR OWN FIREBASE CONFIGURATION HERE.
        // Get this from your Firebase project settings.
        // You also need to set up Firestore.
        // ====================================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = firebaseConfig.appId || 'default-app-id';

        // Placeholder for user profile since auth is removed
        const userProfile = {
            uid: 'local-admin-user',
            role: 'admin' // Force all features to be accessible
        };

        // Firebase Imports and Initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // =================================
        // Global State & Constants
        // =================================
        const PRODUCTS_COLLECTION = 'products';
        const CUSTOMERS_COLLECTION = 'customers';
        const SALES_COLLECTION = 'sales';

        const store = {
            products: [],
            customers: [],
            sales: [],
            cart: [],
            isImporting: false,
            adminUsers: []
        };

        const elements = {
            navTabs: document.getElementById('navTabs'),
            contentArea: document.getElementById('contentArea'),
            posSection: document.getElementById('posSection'),
            inventorySection: document.getElementById('inventorySection'),
            customersSection: document.getElementById('customersSection'),
            reportsSection: document.getElementById('reportsSection'),
            settingsSection: document.getElementById('settingsSection'),
            productsGrid: document.getElementById('productsGrid'),
            cartItems: document.getElementById('cartItems'),
            customerSelect: document.getElementById('customerSelect'),
            cartTotal: document.getElementById('cartTotal'),
            processSaleBtn: document.getElementById('processSaleBtn'),
            productSearch: document.getElementById('productSearch'),
            cartCheckoutBtn: document.getElementById('cartCheckoutBtn'),
            productTableContainer: document.getElementById('productTableContainer'),
            customerTableContainer: document.getElementById('customerTableContainer'),
            addProductBtn: document.getElementById('addProductBtn'),
            addCustomerBtn: document.getElementById('addCustomerBtn'),
            genericModal: document.getElementById('genericModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            notificationModal: document.getElementById('notificationModal'),
            notificationTitle: document.getElementById('notificationTitle'),
            notificationMessage: document.getElementById('notificationMessage'),
            notificationPrimaryBtn: document.getElementById('notificationPrimaryBtn'),
            notificationSecondaryBtn: document.getElementById('notificationSecondaryBtn'),
            totalSales: document.getElementById('totalSales'),
            totalRevenue: document.getElementById('totalRevenue'),
            totalProfit: document.getElementById('totalProfit'),
            totalCost: document.getElementById('totalCost'),
            salesHistoryTableContainer: document.getElementById('salesHistoryTableContainer'),
            topSellingProductsTableBody: document.getElementById('topSellingProductsTableBody'),
            importBtn: document.getElementById('importBtn'),
            importModal: document.getElementById('importModal'),
            closeImportModalBtn: document.getElementById('closeImportModalBtn'),
            importType: document.getElementById('importType'),
            importFile: document.getElementById('importFile'),
            confirmImportBtn: document.getElementById('confirmImportBtn'),
            exportAllDataBtn: document.getElementById('exportAllDataBtn'),
            appContainer: document.getElementById('appContainer')
        };

        // =================================
        // Helper Functions
        // =================================

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        };

        const showModal = (title, content, showPrimaryBtn = true, primaryBtnText = 'Confirm', showSecondaryBtn = false, onPrimaryClick = null, onSecondaryClick = null) => {
            elements.modalTitle.textContent = title;
            elements.modalContent.innerHTML = content;
            elements.genericModal.classList.remove('hidden');

            const primaryBtn = document.getElementById('modalPrimaryBtn');
            const secondaryBtn = document.getElementById('modalSecondaryBtn');

            // Remove existing event listeners to prevent duplicates
            const newPrimaryBtn = primaryBtn ? primaryBtn.cloneNode(true) : null;
            const newSecondaryBtn = secondaryBtn ? secondaryBtn.cloneNode(true) : null;
            if (newPrimaryBtn) {
                primaryBtn.parentNode.replaceChild(newPrimaryBtn, primaryBtn);
            }
            if (newSecondaryBtn) {
                secondaryBtn.parentNode.replaceChild(newSecondaryBtn, secondaryBtn);
            }

            if (showPrimaryBtn && newPrimaryBtn) {
                newPrimaryBtn.textContent = primaryBtnText;
                newPrimaryBtn.classList.remove('hidden');
                newPrimaryBtn.onclick = onPrimaryClick;
            } else if (newPrimaryBtn) {
                newPrimaryBtn.classList.add('hidden');
            }

            if (showSecondaryBtn && newSecondaryBtn) {
                newSecondaryBtn.onclick = onSecondaryClick;
                newSecondaryBtn.classList.remove('hidden');
            } else if (newSecondaryBtn) {
                newSecondaryBtn.classList.add('hidden');
            }
        };

        const hideModal = () => {
            elements.genericModal.classList.add('hidden');
            elements.modalContent.innerHTML = '';
        };

        const showNotification = (title, message, showSecondaryBtn = false, onPrimaryClick = null, onSecondaryClick = null) => {
            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;
            elements.notificationModal.classList.remove('hidden');

            elements.notificationPrimaryBtn.onclick = onPrimaryClick || (() => hideNotification());
            if (showSecondaryBtn) {
                elements.notificationSecondaryBtn.classList.remove('hidden');
                elements.notificationSecondaryBtn.onclick = onSecondaryClick || (() => hideNotification());
            } else {
                elements.notificationSecondaryBtn.classList.add('hidden');
            }
        };

        const hideNotification = () => {
            elements.notificationModal.classList.add('hidden');
        };

        const calculateReports = () => {
            let totalSales = 0;
            let totalRevenue = 0;
            let totalProfit = 0;

            const topSellingProducts = {};

            store.sales.forEach(sale => {
                totalSales += 1;
                totalRevenue += sale.totalPrice;
                sale.products.forEach(product => {
                    const cost = product.cost || 0;
                    totalProfit += (product.price - cost) * product.quantity;
                    if (topSellingProducts[product.name]) {
                        topSellingProducts[product.name].quantity += product.quantity;
                        topSellingProducts[product.name].revenue += product.price * product.quantity;
                    } else {
                        topSellingProducts[product.name] = {
                            quantity: product.quantity,
                            revenue: product.price * product.quantity
                        };
                    }
                });
            });

            elements.totalSales.textContent = totalSales;
            elements.totalRevenue.textContent = formatCurrency(totalRevenue);
            elements.totalProfit.textContent = formatCurrency(totalProfit);
            elements.totalCost.textContent = formatCurrency(totalRevenue - totalProfit);

            renderTopSellingProducts(topSellingProducts);
        };

        const renderTopSellingProducts = (products) => {
            const sortedProducts = Object.entries(products).sort(([, a], [, b]) => b.quantity - a.quantity);
            const html = sortedProducts.slice(0, 10).map(([name, data]) => `
                <tr class="bg-white border-b hover:bg-gray-50 transition-colors duration-200">
                    <td class="py-3 px-6">${name}</td>
                    <td class="py-3 px-6">${data.quantity}</td>
                    <td class="py-3 px-6">${formatCurrency(data.revenue)}</td>
                </tr>
            `).join('');
            elements.topSellingProductsTableBody.innerHTML = html;
        };

        // =================================
        // Render Functions
        // =================================
        const renderProducts = (searchTerm = '') => {
            const filteredProducts = store.products.filter(product =>
                product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.sku.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.barcodeId.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const html = filteredProducts.map(product => `
                <div class="product-card bg-white rounded-xl shadow-md p-4 flex flex-col items-center text-center cursor-pointer transition-transform duration-200" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}" data-cost="${product.cost || 0}">
                    <img src="${product.imageUrl || 'https://placehold.co/100x100'}" alt="${product.name}" class="w-24 h-24 object-cover rounded-lg mb-2">
                    <p class="font-semibold text-gray-800">${product.name}</p>
                    <p class="text-sm text-gray-500">${product.sku}</p>
                    <p class="text-xs text-gray-400">Barcode: ${product.barcodeId}</p>
                    <p class="font-bold text-lg text-indigo-600">${formatCurrency(product.price)}</p>
                    <p class="text-xs text-red-500">Stock: ${product.stock}</p>
                </div>
            `).join('');
            elements.productsGrid.innerHTML = html;
        };

        const renderCart = () => {
            const html = store.cart.map(item => `
                <div class="flex items-center space-x-4 p-2 bg-white rounded-lg shadow-sm mb-2">
                    <img src="${item.imageUrl || 'https://placehold.co/50x50'}" alt="${item.name}" class="w-10 h-10 object-cover rounded">
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${item.name}</p>
                        <p class="text-sm text-gray-500">${formatCurrency(item.price)} x ${item.quantity}</p>
                    </div>
                    <p class="font-bold text-gray-700">${formatCurrency(item.price * item.quantity)}</p>
                    <button class="remove-from-cart-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-id="${item.id}">&times;</button>
                </div>
            `).join('');
            elements.cartItems.innerHTML = html;
            const total = store.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            elements.cartTotal.textContent = formatCurrency(total);
        };

        const renderProductTable = () => {
            const html = `
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="py-3 px-6 rounded-tl-lg">SKU</th>
                            <th scope="col" class="py-3 px-6">Barcode</th>
                            <th scope="col" class="py-3 px-6">Product Name</th>
                            <th scope="col" class="py-3 px-6">Price</th>
                            <th scope="col" class="py-3 px-6">Cost</th>
                            <th scope="col" class="py-3 px-6">Stock</th>
                            <th scope="col" class="py-3 px-6 rounded-tr-lg">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${store.products.map(product => `
                            <tr class="bg-white border-b hover:bg-gray-50 transition-colors duration-200">
                                <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">${product.sku}</td>
                                <td class="py-4 px-6">${product.barcodeId || 'N/A'}</td>
                                <td class="py-4 px-6">${product.name}</td>
                                <td class="py-4 px-6">${formatCurrency(product.price)}</td>
                                <td class="py-4 px-6">${formatCurrency(product.cost || 0)}</td>
                                <td class="py-4 px-6">${product.stock}</td>
                                <td class="py-4 px-6">
                                    <button data-id="${product.id}" class="edit-product-btn text-indigo-600 hover:text-indigo-900 transition-colors duration-200">Edit</button> |
                                    <button data-id="${product.id}" class="delete-product-btn text-red-600 hover:text-red-900 transition-colors duration-200">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            elements.productTableContainer.innerHTML = html;
        };

        const renderCustomerTable = () => {
            const html = `
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="py-3 px-6 rounded-tl-lg">Customer Name</th>
                            <th scope="col" class="py-3 px-6">Email</th>
                            <th scope="col" class="py-3 px-6">Phone</th>
                            <th scope="col" class="py-3 px-6 rounded-tr-lg">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${store.customers.map(customer => `
                            <tr class="bg-white border-b hover:bg-gray-50 transition-colors duration-200">
                                <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">${customer.name}</td>
                                <td class="py-4 px-6">${customer.email || 'N/A'}</td>
                                <td class="py-4 px-6">${customer.phone || 'N/A'}</td>
                                <td class="py-4 px-6">
                                    <button data-id="${customer.id}" class="edit-customer-btn text-indigo-600 hover:text-indigo-900 transition-colors duration-200">Edit</button> |
                                    <button data-id="${customer.id}" class="delete-customer-btn text-red-600 hover:text-red-900 transition-colors duration-200">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            elements.customerTableContainer.innerHTML = html;
        };

        const renderCustomerSelect = () => {
            const html = `
                <option value="">Select Customer (Optional)</option>
                ${store.customers.map(customer => `
                    <option value="${customer.id}">${customer.name}</option>
                `).join('')}
            `;
            elements.customerSelect.innerHTML = html;
        };

        const renderSalesHistoryTable = () => {
            const html = `
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="py-3 px-6 rounded-tl-lg">Sale ID</th>
                            <th scope="col" class="py-3 px-6">Customer</th>
                            <th scope="col" class="py-3 px-6">Date</th>
                            <th scope="col" class="py-3 px-6 rounded-tr-lg">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${store.sales.map(sale => `
                            <tr class="bg-white border-b hover:bg-gray-50 transition-colors duration-200">
                                <td class="py-4 px-6">${sale.id.substring(0, 8)}...</td>
                                <td class="py-4 px-6">${sale.customerName || 'Walk-in Customer'}</td>
                                <td class="py-4 px-6">${new Date(sale.timestamp.seconds * 1000).toLocaleDateString()}</td>
                                <td class="py-4 px-6">${formatCurrency(sale.totalPrice)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            elements.salesHistoryTableContainer.innerHTML = html;
        };

        // =================================
        // Modal Handlers
        // =================================
        const handleAddEditProduct = (isEdit = false, productId = null) => {
            const product = isEdit ? store.products.find(p => p.id === productId) : {};
            const title = isEdit ? `Edit Product: ${product.name}` : 'Add New Product';
            const content = `
                <form id="productForm" class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="product-name" name="name" value="${product.name || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div>
                        <label for="product-sku" class="block text-sm font-medium text-gray-700">SKU</label>
                        <input type="text" id="product-sku" name="sku" value="${product.sku || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div>
                        <label for="product-barcode" class="block text-sm font-medium text-gray-700">Barcode ID</label>
                        <input type="text" id="product-barcode" name="barcodeId" value="${product.barcodeId || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="product-price" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" id="product-price" name="price" value="${product.price || ''}" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div>
                        <label for="product-cost" class="block text-sm font-medium text-gray-700">Cost (for profit calculation)</label>
                        <input type="number" id="product-cost" name="cost" value="${product.cost || ''}" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="product-stock" class="block text-sm font-medium text-gray-700">Stock</label>
                        <input type="number" id="product-stock" name="stock" value="${product.stock || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition-colors duration-200">
                            ${isEdit ? 'Update Product' : 'Add Product'}
                        </button>
                    </div>
                </form>
            `;

            showModal(title, content);

            document.getElementById('productForm').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                data.price = parseFloat(data.price);
                data.cost = parseFloat(data.cost) || 0;
                data.stock = parseInt(data.stock, 10);

                try {
                    if (isEdit) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION, productId), data);
                        showNotification('Success!', 'Product updated successfully.');
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION), data);
                        showNotification('Success!', 'New product added successfully.');
                    }
                    hideModal();
                } catch (error) {
                    console.error("Error writing document: ", error);
                    showNotification('Error', 'Failed to save product. Please try again.');
                }
            };
        };

        const handleAddEditCustomer = (isEdit = false, customerId = null) => {
            const customer = isEdit ? store.customers.find(c => c.id === customerId) : {};
            const title = isEdit ? `Edit Customer: ${customer.name}` : 'Add New Customer';
            const content = `
                <form id="customerForm" class="space-y-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="customer-name" name="name" value="${customer.name || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div>
                        <label for="customer-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="customer-email" name="email" value="${customer.email || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" id="customer-phone" name="phone" value="${customer.phone || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition-colors duration-200">
                            ${isEdit ? 'Update Customer' : 'Add Customer'}
                        </button>
                    </div>
                </form>
            `;
            showModal(title, content);

            document.getElementById('customerForm').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                try {
                    if (isEdit) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION, customerId), data);
                        showNotification('Success!', 'Customer updated successfully.');
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION), data);
                        showNotification('Success!', 'New customer added successfully.');
                    }
                    hideModal();
                } catch (error) {
                    console.error("Error writing document: ", error);
                    showNotification('Error', 'Failed to save customer. Please try again.');
                }
            };
        };

        // =================================
        // Event Listeners
        // =================================

        elements.navTabs.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (target) {
                document.querySelectorAll('.tab-content').forEach(section => section.classList.add('hidden'));
                document.querySelectorAll('#navTabs button').forEach(btn => btn.classList.remove('active-tab', 'bg-indigo-600', 'text-white'));

                document.getElementById(`${target.dataset.tab}Section`).classList.remove('hidden');
                target.classList.add('active-tab', 'bg-indigo-600', 'text-white');
            }
        });

        document.getElementById('posSection').classList.remove('hidden');
        document.querySelector('[data-tab="pos"]').classList.add('active-tab', 'bg-indigo-600', 'text-white');

        elements.productsGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.product-card');
            if (card) {
                const id = card.dataset.id;
                const existingItem = store.cart.find(item => item.id === id);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    const product = store.products.find(p => p.id === id);
                    store.cart.push({ ...product, quantity: 1 });
                }
                renderCart();
            }
        });

        elements.cartItems.addEventListener('click', (e) => {
            const btn = e.target.closest('.remove-from-cart-btn');
            if (btn) {
                const id = btn.dataset.id;
                store.cart = store.cart.filter(item => item.id !== id);
                renderCart();
            }
        });

        elements.productSearch.addEventListener('input', (e) => {
            renderProducts(e.target.value);
        });

        elements.cartCheckoutBtn.addEventListener('click', () => {
            elements.posSection.classList.add('hidden');
            document.querySelectorAll('#navTabs button').forEach(btn => btn.classList.remove('active-tab', 'bg-indigo-600', 'text-white'));
            elements.inventorySection.classList.remove('hidden');
            document.querySelector('[data-tab="inventory"]').classList.add('active-tab', 'bg-indigo-600', 'text-white');
        });

        elements.processSaleBtn.addEventListener('click', async () => {
            if (store.cart.length === 0) {
                showNotification('Empty Cart', 'Please add products to the cart before processing a sale.');
                return;
            }

            try {
                const saleTotal = store.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const customerId = elements.customerSelect.value;
                const customerName = customerId ? store.customers.find(c => c.id === customerId)?.name : 'Walk-in Customer';
                const saleData = {
                    products: store.cart.map(({ id, name, price, quantity, cost }) => ({ id, name, price, quantity, cost })),
                    totalPrice: saleTotal,
                    customerId,
                    customerName,
                    timestamp: new Date()
                };

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', SALES_COLLECTION), saleData);

                for (const item of store.cart) {
                    const productRef = doc(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION, item.id);
                    await updateDoc(productRef, {
                        stock: store.products.find(p => p.id === item.id).stock - item.quantity
                    });
                }

                store.cart = [];
                renderCart();
                showNotification('Sale Processed', 'The sale has been successfully completed.');
            } catch (error) {
                console.error("Error processing sale: ", error);
                showNotification('Error', 'Failed to process sale. Please try again.');
            }
        });

        elements.addProductBtn.addEventListener('click', () => handleAddEditProduct(false));
        elements.addCustomerBtn.addEventListener('click', () => handleAddEditCustomer(false));

        elements.productTableContainer.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-product-btn');
            const deleteBtn = e.target.closest('.delete-product-btn');
            if (editBtn) {
                handleAddEditProduct(true, editBtn.dataset.id);
            } else if (deleteBtn) {
                showNotification('Confirm Delete', 'Are you sure you want to delete this product?', true,
                    async () => {
                        try {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION, deleteBtn.dataset.id));
                            hideNotification();
                            showNotification('Success!', 'Product deleted successfully.');
                        } catch (error) {
                            console.error("Error deleting document: ", error);
                            showNotification('Error', 'Failed to delete product. Please try again.');
                        }
                    }, hideNotification);
            }
        });

        elements.customerTableContainer.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-customer-btn');
            const deleteBtn = e.target.closest('.delete-customer-btn');
            if (editBtn) {
                handleAddEditCustomer(true, editBtn.dataset.id);
            } else if (deleteBtn) {
                showNotification('Confirm Delete', 'Are you sure you want to delete this customer?', true,
                    async () => {
                        try {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION, deleteBtn.dataset.id));
                            hideNotification();
                            showNotification('Success!', 'Customer deleted successfully.');
                        } catch (error) {
                            console.error("Error deleting document: ", error);
                            showNotification('Error', 'Failed to delete customer. Please try again.');
                        }
                    }, hideNotification);
            }
        });

        elements.closeModalBtn.addEventListener('click', hideModal);
        elements.closeImportModalBtn.addEventListener('click', () => elements.importModal.classList.add('hidden'));

        elements.importBtn.addEventListener('click', () => elements.importModal.classList.remove('hidden'));

        elements.confirmImportBtn.addEventListener('click', async () => {
            const file = elements.importFile.files[0];
            const importType = elements.importType.value;
            if (!file) {
                showNotification('No File', 'Please select a CSV file to import.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n').map(row => row.trim()).filter(row => row.length > 0);
                const headers = rows[0].split(',').map(header => header.trim());
                const dataRows = rows.slice(1);

                const dataToImport = dataRows.map(row => {
                    const values = row.split(',').map(val => val.trim());
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    return obj;
                });

                store.isImporting = true;
                showNotification('Importing Data...', `Importing ${dataToImport.length} ${importType} records. This may take a moment.`, false, null, null);
                elements.importModal.classList.add('hidden');

                try {
                    const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', importType === 'products' ? PRODUCTS_COLLECTION : CUSTOMERS_COLLECTION);
                    const currentDocs = (await getDocs(collectionRef)).docs;
                    const batch = db.batch();

                    currentDocs.forEach(doc => batch.delete(doc.ref));

                    dataToImport.forEach(item => {
                        const docRef = doc(collectionRef);
                        // Convert numeric fields to numbers
                        if (importType === 'products') {
                            item.price = parseFloat(item.price);
                            item.cost = parseFloat(item.cost) || 0;
                            item.stock = parseInt(item.stock, 10);
                        }
                        batch.set(docRef, item);
                    });

                    await batch.commit();
                    showNotification('Import Complete', `Successfully imported ${dataToImport.length} ${importType} records.`);
                } catch (error) {
                    console.error("Error importing data:", error);
                    showNotification('Import Failed', 'An error occurred during import. Please check your CSV format and try again.');
                } finally {
                    store.isImporting = false;
                }
            };
            reader.readAsText(file);
        });

        elements.exportAllDataBtn.addEventListener('click', async () => {
            try {
                const products = (await getDocs(collection(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION))).docs.map(doc => doc.data());
                const customers = (await getDocs(collection(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION))).docs.map(doc => doc.data());
                const sales = (await getDocs(collection(db, 'artifacts', appId, 'public', 'data', SALES_COLLECTION))).docs.map(doc => doc.data());

                const data = {
                    products,
                    customers,
                    sales
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wholesale_data_export_${new Date().toISOString()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Export Complete', 'All data has been successfully exported as a JSON file.');
            } catch (error) {
                console.error("Error exporting data: ", error);
                showNotification('Export Failed', 'An error occurred during data export. Please try again.');
            }
        });

        // =================================
        // Main App Logic
        // =================================

        const setupFirestoreListeners = () => {
            // Products Listener
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', PRODUCTS_COLLECTION), (snapshot) => {
                store.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
                renderProductTable();
                if (!store.isImporting) {
                    calculateReports();
                }
            });

            // Customers Listener
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', CUSTOMERS_COLLECTION), (snapshot) => {
                store.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCustomerSelect();
                renderCustomerTable();
            });

            // Sales Listener
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', SALES_COLLECTION), (snapshot) => {
                store.sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSalesHistoryTable();
                if (!store.isImporting) {
                    calculateReports();
                }
            });
        };

        // Initialize the app directly since authentication is removed
        setupFirestoreListeners();
        elements.appContainer.classList.remove('hidden');

    </script>

</body>
</html>
